<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WORKLY - Servicios Disponibles</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
            color: #2c3e50 !important;
        }
        .hero-section {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 2.5rem 0;
        }
        .category-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
            background: white;
        }
        .category-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .service-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
            transition: all 0.3s ease;
            background: white;
        }
        .service-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .talent-card {
            border-left: 4px solid #3498db;
            background: #f8f9fa;
        }
        .empresa-card {
            border-left: 4px solid #27ae60;
            background: #f8f9fa;
        }
        .btn-workly {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            border: none;
            color: white;
            font-weight: 500;
        }
        .btn-workly:hover {
            background: linear-gradient(135deg, #34495e 0%, #2980b9 100%);
            color: white;
        }
        .user-welcome {
            color: #2c3e50;
            font-weight: 500;
        }
        .card-header {
            background: white !important;
            border-bottom: 1px solid #e9ecef;
            color: #2c3e50;
        }
        .login-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        .more-categories {
            display: none;
        }
        .show-more-btn {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 5px 0;
        }
        .show-more-btn:hover {
            text-decoration: underline;
        }
        .text-truncate-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .category-active {
            background-color: #3498db !important;
            color: white !important;
            font-weight: bold;
        }
        .category-filter {
            cursor: pointer;
        }
        .no-results {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        .back-to-all {
            margin-bottom: 1rem;
        }
        .results-counter {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 20px;
        }
        .badge-empresa {
            background-color: #27ae60;
        }
        .badge-talento {
            background-color: #3498db;
        }
        .rating-stars {
            color: #ffc107;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .rating-stars .star {
            transition: all 0.2s ease;
        }
        .rating-stars .star:hover {
            transform: scale(1.2);
        }
        .info-item {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        .info-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .info-value {
            color: #495057;
        }
        .rating-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #3498db;
        }
        .rating-user {
            font-weight: 600;
            color: #2c3e50;
        }
        .rating-date {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .card-footer {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn-rating {
            background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);
            border: none;
            color: white;
        }
        .btn-rating:hover {
            background: linear-gradient(135deg, #e0a800 0%, #e67e00 100%);
            color: white;
        }
        .average-rating {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }
        .search-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .search-box {
            position: relative;
        }
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        .search-input {
            padding-left: 40px;
            border-radius: 20px;
            border: 1px solid #dee2e6;
        }
        .search-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        }
        .search-clear {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
        }
        .search-clear:hover {
            color: #2c3e50;
        }
        .search-results {
            margin-top: 10px;
            font-size: 0.9rem;
        }
        .search-active {
            border: 2px solid #3498db;
        }
        .search-hint {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p>Verificando autenticaci√≥n...</p>
        </div>
    </div>

    <!-- Modal para requerir login -->
    <div class="modal fade" id="loginRequiredModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üîê Inicio de Sesi√≥n Requerido</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Para acceder a esta funci√≥n necesitas iniciar sesi√≥n en tu cuenta.</p>
                    <div class="alert alert-info">
                        <small>¬øNo tienes cuenta? <a href="/register/" class="alert-link">Reg√≠strate gratis</a></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <a href="/login/" class="btn btn-workly">Iniciar Sesi√≥n</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalles de empresa/servicio -->
    <div class="modal fade" id="empresaDetailsModal" tabindex="-1" aria-labelledby="empresaDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="empresaDetailsModalLabel">Detalles del Servicio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="empresaDetailsContent">
                    <!-- Contenido din√°mico se cargar√° aqu√≠ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalles de talento -->
    <div class="modal fade" id="talentoDetailsModal" tabindex="-1" aria-labelledby="talentoDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="talentoDetailsModalLabel">Detalles del Talento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="talentoDetailsContent">
                    <!-- Contenido din√°mico se cargar√° aqu√≠ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para calificar -->
    <div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="ratingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ratingModalLabel">Calificar Talento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="ratingContent">
                    <!-- Contenido din√°mico se cargar√° aqu√≠ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-workly" id="confirmRatingBtn">Confirmar Calificaci√≥n</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para calificar empresa -->
    <div class="modal fade" id="ratingEmpresaModal" tabindex="-1" aria-labelledby="ratingEmpresaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ratingEmpresaModalLabel">Calificar Empresa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="ratingEmpresaContent">
                    <!-- Contenido din√°mico se cargar√° aqu√≠ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-workly" id="confirmEmpresaRatingBtn">Confirmar Calificaci√≥n</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
        <div class="container">
            <a class="navbar-brand" href="/">üöÄ WORKLY</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3 user-welcome" id="userWelcome">
                    üëã Bienvenido a WORKLY
                </span>
                <div id="authButtons">
                    <a href="/login/" class="btn btn-workly btn-sm me-2">Iniciar Sesi√≥n</a>
                    <a href="/register/" class="btn btn-outline-dark btn-sm">Registrarse</a>
                </div>
                <div id="userMenu" style="display: none;">
                    <a href="/publicarme/" class="btn btn-workly btn-sm me-2">üìù Publicarme</a>
                    <a href="/profile/" class="btn btn-outline-primary btn-sm me-2">Mi Perfil</a>
                    <button class="btn btn-outline-dark btn-sm" onclick="logout()">Cerrar Sesi√≥n</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- P√°gina Principal -->
    <div id="mainPage" style="display: none;">
        <!-- Hero Section -->
        <section class="hero-section">
            <div class="container text-center">
                <h1 class="display-5 fw-bold">Servicios Disponibles</h1>
                <p class="lead">Encuentra los mejores profesionales y servicios en WORKLY</p>
            </div>
        </section>

        <!-- Main Content -->
        <div class="container my-5">
            <div class="row">
                <!-- Sidebar - Categor√≠as -->
                <div class="col-lg-3 mb-4">
                    <div class="card category-card">
                        <div class="card-header">
                            <h5 class="mb-0">üìã Categor√≠as</h5>
                        </div>
                        <div class="card-body">
                            <div class="list-group list-group-flush" id="categoriesList">
                                <div class="text-center">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Cargando categor√≠as...</span>
                                    </div>
                                    <small class="text-muted">Cargando categor√≠as...</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content - Servicios -->
                <div class="col-lg-9">
                    <!-- Barra de b√∫squeda -->
                    <div class="search-container" id="searchContainer">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" 
                                   class="form-control search-input" 
                                   id="searchInput" 
                                   placeholder="üîç Buscar servicios o usuarios..."
                                   onkeyup="handleSearch(event)">
                            <button class="search-clear" id="searchClearBtn" onclick="clearSearch()" style="display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="search-hint" id="searchHint">
                            <!-- Aqu√≠ se mostrar√° la categor√≠a actual cuando haya b√∫squeda -->
                        </div>
                        <div class="search-results text-muted" id="searchResults" style="display: none;">
                            <small id="searchResultsText"></small>
                        </div>
                    </div>

                    <!-- Contenido P√∫blico (siempre visible) -->
                    <div class="row" id="publicContent">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <strong>üí° Explora nuestros servicios:</strong> Puedes ver toda la informaci√≥n. <strong>Inicia sesi√≥n</strong> para ver m√°s detalles y categor√≠as espec√≠ficas.
                            </div>
                        </div>
                    </div>

                    <!-- Bot√≥n para volver a todas las categor√≠as (oculto inicialmente) -->
                    <div class="row mb-3" id="backToAllContainer" style="display: none;">
                        <div class="col-12">
                            <button class="btn btn-outline-primary btn-sm back-to-all" onclick="showAllCategories()">
                                ‚Üê Volver a todas las categor√≠as
                            </button>
                        </div>
                    </div>

                    <!-- T√≠tulo de categor√≠a seleccionada -->
                    <div class="row mb-4" id="categoryTitleContainer" style="display: none;">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0" id="categoryTitle">Categor√≠a Seleccionada</h5>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contador de resultados -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="results-counter">
                                <small class="text-muted" id="resultsCounter">
                                    <strong id="totalResults">0</strong> servicios encontrados
                                    <span id="categoryFilterText" style="display: none;"> en <strong id="categoryName"></strong></span>
                                    <span class="float-end">
                                        <strong id="empresasCount">0</strong> empresas ‚Ä¢ 
                                        <strong id="talentosCount">0</strong> talentos
                                    </span>
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Empresas/Servicios Destacados -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">üè¢ Servicios y Empresas Destacadas</h5>
                                    <span class="badge badge-empresa">Empresas</span>
                                </div>
                                <div class="card-body">
                                    <div class="row" id="empresasContainer">
                                        <div class="col-12 text-center">
                                            <div class="spinner-border" role="status">
                                                <span class="visually-hidden">Cargando servicios...</span>
                                            </div>
                                            <p class="text-muted mt-2">Cargando servicios disponibles...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Talentos Humanos Disponibles -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">üë• Talentos Humanos Disponibles</h5>
                                    <span class="badge badge-talento">Talentos</span>
                                </div>
                                <div class="card-body">
                                    <div class="row" id="talentosContainer">
                                        <div class="col-12 text-center">
                                            <div class="spinner-border" role="status">
                                                <span class="visually-hidden">Cargando talentos...</span>
                                            </div>
                                            <p class="text-muted mt-2">Cargando talentos disponibles...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>üöÄ WORKLY</h5>
                    <p class="text-muted">Tu plataforma de confianza para servicios profesionales</p>
                </div>
                <div class="col-md-6 text-end">
                    <p class="text-muted">&copy; 2024 WORKLY. Todos los derechos reservados.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Font Awesome para iconos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

    <script>
        // URLs CONFIGURADAS
        const BACKEND_URL = 'http://127.0.0.1:8001';

        // Modales de Bootstrap
        const loginRequiredModal = new bootstrap.Modal(document.getElementById('loginRequiredModal'));
        const empresaDetailsModal = new bootstrap.Modal(document.getElementById('empresaDetailsModal'));
        const talentoDetailsModal = new bootstrap.Modal(document.getElementById('talentoDetailsModal'));
        const ratingModal = new bootstrap.Modal(document.getElementById('ratingModal'));
        const ratingEmpresaModal = new bootstrap.Modal(document.getElementById('ratingEmpresaModal'));

        // Variables globales
        let categoriasData = [];
        let publicidadesData = [];
        let usuariosData = {};
        let categoriaSeleccionada = null;
        let currentRating = 0;
        let currentPublicidadId = null;
        let currentRatingType = null;
        let busquedaActiva = false;
        let terminoBusqueda = '';
        
        // Almacenamiento de calificaciones
        let calificacionesData = JSON.parse(localStorage.getItem('workly_calificaciones')) || {};
        let calificacionesEmpresasData = JSON.parse(localStorage.getItem('workly_calificaciones_empresas')) || {};

        // Verificar autenticaci√≥n ANTES de cargar la p√°gina
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuthentication();
            // Una vez verificada la autenticaci√≥n, mostrar la p√°gina y cargar datos
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('mainPage').style.display = 'block';
            loadInitialData();
        });

        // Cargar datos iniciales
        async function loadInitialData() {
            try {
                // Primero cargar categor√≠as
                await loadCategorias();
                
                // Luego cargar publicidades y usuarios en paralelo
                await Promise.all([
                    loadPublicidades(),
                    loadUsuarios()
                ]);
                
                renderHomeContent();
                
            } catch (error) {
                showError('Error al cargar los datos');
            }
        }

        // Funci√≥n para determinar si es Empresa o Talento
        function esEmpresa(publicidad) {
            if (publicidad.tipo_publicidad !== undefined) {
                const tipo = publicidad.tipo_publicidad.toLowerCase();
                return tipo.includes('empresa') || tipo.includes('servicio') || tipo.includes('company');
            }
            
            if (publicidad.tipo_usuario !== undefined) {
                const tipo = publicidad.tipo_usuario.toLowerCase();
                return tipo.includes('empresa') || tipo.includes('company');
            }
            
            const titulo = publicidad.titulo_publicidad ? publicidad.titulo_publicidad.toLowerCase() : '';
            const descripcion = publicidad.descripcion_detallada ? publicidad.descripcion_detallada.toLowerCase() : '';
            
            const palabrasEmpresa = [
                'empresa', 'servicio', 'compa√±√≠a', 'company', 'business', 
                'corporaci√≥n', 'corporacion', 's.a.', 's.a', 'limitada', 
                'corporativo', 'corporate', 'enterprise', 'emprendimiento',
                'sociedad', 'firma', 'organizaci√≥n', 'organizacion',
                'consultor√≠a', 'consultoria', 'estudio', 'agencia',
                'servicios', 'workshop', 'atelier', 'negocio',
                'solutions', 'group', 'tech', 'digital', 'marketing',
                'construcci√≥n', 'construccion', 'electricidad',
                'plomer√≠a', 'plomeria', 'carpinter√≠a', 'carpinteria',
                'refrigeraci√≥n', 'refrigeracion', 'mec√°nica', 'mecanica',
                'turismo', 'limpieza', 'reposter√≠a', 'reposteria',
                'educaci√≥n', 'educacion', 'cuidado', 'belleza',
                'programaci√≥n', 'programacion', 'dise√±o'
            ];
            
            const palabrasTalento = [
                'talento', 'freelance', 'independiente', 'personal', 'profesional',
                'individual', 'consultor', 'asesor', 'freelancer', 'aut√≥nomo',
                'autonomo', 'persona', 'experto', 'especialista',
                'developer', 'desarrollador', 'dise√±ador', 'dise√±adora',
                'programador', 'programadora', 'ingeniero', 'ingeniera',
                'arquitecto', 'arquitecta', 'abogado', 'abogada',
                'contador', 'contadora', 'psic√≥logo', 'psicologa',
                'maestro', 'maestra', 'profesor', 'profesora',
                'coach', 'mentor', 'tutor', 'instructor'
            ];
            
            let contadorEmpresa = 0;
            let contadorTalento = 0;
            
            palabrasEmpresa.forEach(palabra => {
                if (titulo.includes(palabra) || descripcion.includes(palabra)) {
                    contadorEmpresa++;
                }
            });
            
            palabrasTalento.forEach(palabra => {
                if (titulo.includes(palabra) || descripcion.includes(palabra)) {
                    contadorTalento++;
                }
            });
            
            if (contadorEmpresa > contadorTalento) {
                return true;
            } else if (contadorTalento > contadorEmpresa) {
                return false;
            }
            
            if (titulo.includes('talento:')) {
                return false;
            }
            
            if (titulo.includes('empresa:') || titulo.includes('servicio:')) {
                return true;
            }
            
            let usuarioId = null;
            if (publicidad.id_usuario_id !== undefined && publicidad.id_usuario_id !== null) {
                usuarioId = publicidad.id_usuario_id;
            } else if (publicidad.id_usuario !== undefined && publicidad.id_usuario !== null) {
                usuarioId = publicidad.id_usuario;
            } else if (publicidad.usuario_id !== undefined && publicidad.usuario_id !== null) {
                usuarioId = publicidad.usuario_id;
            }
            
            if (usuarioId && usuariosData[usuarioId]) {
                const usuario = usuariosData[usuarioId];
                if (usuario.tipo_usuario) {
                    const tipo = usuario.tipo_usuario.toLowerCase();
                    return tipo.includes('empresa');
                }
            }
            
            if (contadorEmpresa > 0) {
                return true;
            }
            
            return false;
        }

        // Separar publicidades en Empresas y Talentos
        function separarEmpresasYTalentos(publicidades) {
            const empresas = [];
            const talentos = [];
            
            publicidades.forEach(publicidad => {
                if (esEmpresa(publicidad)) {
                    empresas.push(publicidad);
                } else {
                    talentos.push(publicidad);
                }
            });
            
            return { empresas, talentos };
        }

        // Cargar categor√≠as desde la API
        async function loadCategorias() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/categorias/`);
                
                if (!response.ok) {
                    throw new Error(`Error al cargar categor√≠as: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (Array.isArray(data)) {
                    categoriasData = data;
                } else if (data.results && Array.isArray(data.results)) {
                    categoriasData = data.results;
                } else if (data.data && Array.isArray(data.data)) {
                    categoriasData = data.data;
                } else {
                    for (const key in data) {
                        if (Array.isArray(data[key])) {
                            categoriasData = data[key];
                            break;
                        }
                    }
                }
                
                // Categor√≠as de emergencia si hay error
                if (categoriasData.length === 0) {
                    categoriasData = [
                        { id_categoria: 1, nombre_categoria: 'Electricidad' },
                        { id_categoria: 2, nombre_categoria: 'Construcci√≥n' },
                        { id_categoria: 3, nombre_categoria: 'Plomer√≠a' },
                        { id_categoria: 4, nombre_categoria: 'Carpinter√≠a' },
                        { id_categoria: 5, nombre_categoria: 'Refrigeraci√≥n / Aire Acondicionado' },
                        { id_categoria: 6, nombre_categoria: 'Mec√°nica automotriz' },
                        { id_categoria: 7, nombre_categoria: 'Turismo / Gu√≠as / Hoteler√≠a' },
                        { id_categoria: 8, nombre_categoria: 'Limpieza' },
                        { id_categoria: 9, nombre_categoria: 'Reposter√≠a' },
                        { id_categoria: 10, nombre_categoria: 'Tutor√≠as / Educaci√≥n' },
                        { id_categoria: 11, nombre_categoria: 'Cuidado infantil / Adultos mayores' },
                        { id_categoria: 12, nombre_categoria: 'Belleza' },
                        { id_categoria: 13, nombre_categoria: 'Otros' }
                    ];
                }
                
                renderCategorias();
                
            } catch (error) {
                categoriasData = [
                    { id_categoria: 1, nombre_categoria: 'Electricidad' },
                    { id_categoria: 2, nombre_categoria: 'Construcci√≥n' },
                    { id_categoria: 3, nombre_categoria: 'Plomer√≠a' },
                    { id_categoria: 4, nombre_categoria: 'Carpinter√≠a' },
                    { id_categoria: 5, nombre_categoria: 'Refrigeraci√≥n / Aire Acondicionado' },
                    { id_categoria: 6, nombre_categoria: 'Mec√°nica automotriz' },
                    { id_categoria: 7, nombre_categoria: 'Turismo / Gu√≠as / Hoteler√≠a' },
                    { id_categoria: 8, nombre_categoria: 'Limpieza' },
                    { id_categoria: 9, nombre_categoria: 'Reposter√≠a' },
                    { id_categoria: 10, nombre_categoria: 'Tutor√≠as / Educaci√≥n' },
                    { id_categoria: 11, nombre_categoria: 'Cuidado infantil / Adultos mayores' },
                    { id_categoria: 12, nombre_categoria: 'Belleza' },
                    { id_categoria: 13, nombre_categoria: 'Otros' }
                ];
                renderCategorias();
            }
        }

        // Cargar publicidades desde la API
        async function loadPublicidades() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/publicidades/`);
                if (!response.ok) throw new Error('Error al cargar publicidades');
                
                const data = await response.json();
                
                if (Array.isArray(data)) {
                    publicidadesData = data;
                } else if (data.results && Array.isArray(data.results)) {
                    publicidadesData = data.results;
                } else if (data.data && Array.isArray(data.data)) {
                    publicidadesData = data.data;
                } else {
                    throw new Error('Formato de respuesta no reconocido');
                }
                
            } catch (error) {
                throw error;
            }
        }

        // Cargar usuarios desde la API
        async function loadUsuarios() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/usuarios/`);
                if (!response.ok) {
                    usuariosData = {};
                    return;
                }
                
                const data = await response.json();
                let usuariosArray = [];
                
                if (Array.isArray(data)) {
                    usuariosArray = data;
                } else if (data.results && Array.isArray(data.results)) {
                    usuariosArray = data.results;
                } else if (data.data && Array.isArray(data.data)) {
                    usuariosArray = data.data;
                } else {
                    for (const key in data) {
                        if (Array.isArray(data[key])) {
                            usuariosArray = data[key];
                            break;
                        }
                    }
                }
                
                usuariosData = {};
                usuariosArray.forEach(usuario => {
                    const usuarioId = usuario.id_usuario || usuario.id || usuario.usuario_id;
                    if (usuarioId) {
                        usuariosData[usuarioId] = usuario;
                    }
                });
                
            } catch (error) {
                usuariosData = {};
            }
        }

        // Funci√≥n para obtener nombre de categor√≠a por ID
        function getNombreCategoria(publicidad) {
            const camposPosibles = [
                'id_categoria', 'id_categoria_id', 'categoria_id', 'categoria',
                'idCategoria', 'categoriaId', 'category', 'category_id',
                'categoryId', 'cat_id', 'cat', 'id_cat'
            ];
            
            let categoriaId = null;
            
            for (const campo of camposPosibles) {
                if (publicidad[campo] !== undefined && publicidad[campo] !== null) {
                    if (typeof publicidad[campo] === 'object' && publicidad[campo] !== null) {
                        const obj = publicidad[campo];
                        if (obj.id_categoria !== undefined) {
                            categoriaId = obj.id_categoria;
                        } else if (obj.id !== undefined) {
                            categoriaId = obj.id;
                        } else if (obj.value !== undefined) {
                            categoriaId = obj.value;
                        }
                    } else {
                        categoriaId = publicidad[campo];
                    }
                    break;
                }
            }
            
            if (categoriaId === null) {
                return 'Sin categor√≠a';
            }
            
            let catIdNum;
            if (typeof categoriaId === 'number') {
                catIdNum = categoriaId;
            } else if (typeof categoriaId === 'string' && !isNaN(parseInt(categoriaId))) {
                catIdNum = parseInt(categoriaId);
            } else {
                return `Categor√≠a ${categoriaId}`;
            }
            
            const categoria = categoriasData.find(cat => {
                const catId = cat.id_categoria || cat.id || cat.categoria_id;
                if (catId !== undefined && catId !== null) {
                    const catIdNumComparar = Number(catId);
                    return catIdNumComparar === catIdNum;
                }
                return false;
            });
            
            if (categoria) {
                const nombre = categoria.nombre_categoria || categoria.nombre || `Categor√≠a #${catIdNum}`;
                return nombre;
            }
            
            return `Categor√≠a #${catIdNum}`;
        }

        // Funci√≥n para obtener nombre de usuario por ID
        function getNombreUsuario(publicidad) {
            if (publicidad.usuario_nombre) {
                return publicidad.usuario_nombre;
            }
            
            let usuarioId = null;
            
            if (publicidad.id_usuario_id !== undefined && publicidad.id_usuario_id !== null) {
                usuarioId = publicidad.id_usuario_id;
            } else if (publicidad.id_usuario !== undefined && publicidad.id_usuario !== null) {
                usuarioId = publicidad.id_usuario;
            } else if (publicidad.usuario_id !== undefined && publicidad.usuario_id !== null) {
                usuarioId = publicidad.usuario_id;
            }
            
            if (!usuarioId) {
                return 'Usuario desconocido';
            }
            
            const usuario = usuariosData[usuarioId];
            if (usuario) {
                const nombre = usuario.nombre_completo || usuario.correo_electronico || `Usuario ${usuarioId}`;
                return nombre;
            } else {
                return `Usuario ${usuarioId}`;
            }
        }

        // Funci√≥n para obtener ID de categor√≠a de una publicidad
        function getCategoriaId(publicidad) {
            const camposPosibles = [
                'id_categoria', 'id_categoria_id', 'categoria_id', 'categoria',
                'idCategoria', 'categoriaId', 'category', 'category_id',
                'categoryId', 'cat_id', 'cat', 'id_cat'
            ];
            
            for (const campo of camposPosibles) {
                if (publicidad[campo] !== undefined && publicidad[campo] !== null) {
                    if (typeof publicidad[campo] === 'object' && publicidad[campo] !== null) {
                        const obj = publicidad[campo];
                        if (obj.id_categoria !== undefined) {
                            return obj.id_categoria;
                        } else if (obj.id !== undefined) {
                            return obj.id;
                        } else if (obj.value !== undefined) {
                            return obj.value;
                        }
                    } else {
                        return publicidad[campo];
                    }
                }
            }
            
            return null;
        }

        // Funci√≥n para calcular promedio de calificaciones
        function calcularPromedioCalificaciones(publicidadId, tipo) {
            const calificaciones = tipo === 'empresa' 
                ? calificacionesEmpresasData[publicidadId] || []
                : calificacionesData[publicidadId] || [];
                
            if (calificaciones.length === 0) return 0;
            
            const suma = calificaciones.reduce((total, cal) => total + cal.rating, 0);
            return (suma / calificaciones.length).toFixed(1);
        }

        // Renderizar categor√≠as en el sidebar
        function renderCategorias() {
            const container = document.getElementById('categoriesList');
            
            if (!categoriasData || categoriasData.length === 0) {
                container.innerHTML = '<div class="text-muted">No hay categor√≠as disponibles</div>';
                return;
            }

            let categoriasHTML = '';
            const categoriasVisibles = categoriasData.slice(0, 5);
            const categoriasOcultas = categoriasData.slice(5);

            // Categor√≠a "Todas" (seleccionada por defecto)
            categoriasHTML += `
                <a href="#" class="list-group-item list-group-item-action border-0 category-active category-filter" 
                   onclick="showAllCategories()" data-categoria-id="all">
                    üìÇ Todas las categor√≠as
                </a>
            `;

            // Categor√≠as visibles
            categoriasVisibles.forEach(categoria => {
                const categoriaId = categoria.id_categoria || categoria.id;
                categoriasHTML += `
                    <a href="#" class="list-group-item list-group-item-action border-0 category-filter" 
                       onclick="filterByCategory(${categoriaId})" data-categoria-id="${categoriaId}">
                        ${getCategoryIcon(categoria.nombre_categoria)} ${categoria.nombre_categoria}
                    </a>
                `;
            });

            // Categor√≠as ocultas
            if (categoriasOcultas.length > 0) {
                categoriasHTML += `
                    <div class="more-categories" id="moreCategories" style="display: none;">
                        ${categoriasOcultas.map(categoria => {
                            const categoriaId = categoria.id_categoria || categoria.id;
                            return `
                                <a href="#" class="list-group-item list-group-item-action border-0 category-filter" 
                                   onclick="filterByCategory(${categoriaId})" data-categoria-id="${categoriaId}">
                                    ${getCategoryIcon(categoria.nombre_categoria)} ${categoria.nombre_categoria}
                                </a>
                            `;
                        }).join('')}
                    </div>
                    <button class="show-more-btn mt-2" onclick="toggleMoreCategories()">
                        üìÇ Ver m√°s categor√≠as
                    </button>
                `;
            }

            container.innerHTML = categoriasHTML;
        }

        // FUNCI√ìN DE B√öSQUEDA MEJORADA - Respeta categor√≠a seleccionada
        function handleSearch(event) {
            const searchTerm = event.target.value.trim().toLowerCase();
            terminoBusqueda = searchTerm;
            
            if (searchTerm.length === 0) {
                // Limpiar b√∫squeda
                clearSearch();
                return;
            }
            
            // Mostrar bot√≥n de limpiar
            document.getElementById('searchClearBtn').style.display = 'block';
            document.getElementById('searchContainer').classList.add('search-active');
            
            // Obtener publicidades base seg√∫n categor√≠a seleccionada
            let publicidadesBase = [];
            
            if (categoriaSeleccionada) {
                // Filtrar solo las publicidades de la categor√≠a seleccionada
                const categoriaId = categoriaSeleccionada.id_categoria || categoriaSeleccionada.id;
                publicidadesBase = publicidadesData.filter(publicidad => {
                    const categoriaPubId = getCategoriaId(publicidad);
                    return categoriaPubId !== null && Number(categoriaPubId) === Number(categoriaId);
                });
                
                // Actualizar hint para mostrar que se busca dentro de la categor√≠a
                document.getElementById('searchHint').innerHTML = 
                    `<i class="fas fa-filter"></i> Buscando dentro de: <strong>${categoriaSeleccionada.nombre_categoria}</strong>`;
                document.getElementById('searchHint').style.display = 'block';
            } else {
                // Usar todas las publicidades
                publicidadesBase = publicidadesData;
                document.getElementById('searchHint').style.display = 'none';
            }
            
            // Filtrar publicidades seg√∫n t√©rmino de b√∫squeda
            const publicidadesFiltradas = publicidadesBase.filter(publicidad => {
                // Buscar en t√≠tulo
                const titulo = publicidad.titulo_publicidad ? publicidad.titulo_publicidad.toLowerCase() : '';
                const tituloMatch = titulo.includes(searchTerm);
                
                // Buscar en nombre de usuario
                const nombreUsuario = getNombreUsuario(publicidad).toLowerCase();
                const usuarioMatch = nombreUsuario.includes(searchTerm);
                
                // Buscar en descripci√≥n
                const descripcion = publicidad.descripcion_detallada ? publicidad.descripcion_detallada.toLowerCase() : '';
                const descripcionMatch = descripcion.includes(searchTerm);
                
                return tituloMatch || usuarioMatch || descripcionMatch;
            });
            
            // Separar en empresas y talentos
            const { empresas, talentos } = separarEmpresasYTalentos(publicidadesFiltradas);
            
            // Actualizar UI
            busquedaActiva = true;
            
            // Mostrar resultados de b√∫squeda
            document.getElementById('searchResults').style.display = 'block';
            const totalResultados = empresas.length + talentos.length;
            
            let textoResultados = `<strong>${totalResultados}</strong> resultados para "<strong>${searchTerm}</strong>"`;
            if (categoriaSeleccionada) {
                textoResultados += ` en <strong>${categoriaSeleccionada.nombre_categoria}</strong>`;
            }
            
            document.getElementById('searchResultsText').innerHTML = textoResultados;
            
            // Renderizar resultados
            renderSearchResults(empresas, talentos);
        }

        // Funci√≥n para renderizar resultados de b√∫squeda
        function renderSearchResults(empresas, talentos) {
            // Actualizar contador
            updateResultsCounter(empresas, talentos, categoriaSeleccionada);
            
            // Renderizar empresas
            renderEmpresasFiltradas(empresas, categoriaSeleccionada);
            
            // Renderizar talentos
            renderTalentosFiltrados(talentos, categoriaSeleccionada);
        }

        // Funci√≥n para limpiar b√∫squeda
        function clearSearch() {
            busquedaActiva = false;
            terminoBusqueda = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('searchClearBtn').style.display = 'none';
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchHint').style.display = 'none';
            document.getElementById('searchContainer').classList.remove('search-active');
            
            // Volver al contenido original seg√∫n la categor√≠a seleccionada
            if (categoriaSeleccionada) {
                // Mantener la categor√≠a seleccionada
                filterByCategory(categoriaSeleccionada.id_categoria || categoriaSeleccionada.id);
            } else {
                renderHomeContent();
            }
        }

        // Filtrar publicidades por categor√≠a
        function filterByCategory(categoriaId) {
            if (!requireLogin()) return;
            
            // Limpiar b√∫squeda si est√° activa
            if (busquedaActiva) {
                clearSearch();
            }
            
            const categoria = categoriasData.find(cat => {
                const catId = cat.id_categoria || cat.id;
                return Number(catId) === Number(categoriaId);
            });
            
            if (!categoria) {
                return;
            }
            
            categoriaSeleccionada = categoria;
            
            updateCategoryUI(categoriaId);
            
            function extraerCategoriaId(pub) {
                const campos = ['id_categoria', 'id_categoria_id', 'categoria_id', 'categoria'];
                
                for (const campo of campos) {
                    if (pub[campo] !== undefined && pub[campo] !== null) {
                        let valor = pub[campo];
                        
                        if (typeof valor === 'object' && valor !== null) {
                            if (valor.id_categoria !== undefined) {
                                return valor.id_categoria;
                            } else if (valor.id !== undefined) {
                                return valor.id;
                            }
                        }
                        
                        return valor;
                    }
                }
                return null;
            }
            
            const publicidadesFiltradas = publicidadesData.filter(publicidad => {
                const categoriaPubId = extraerCategoriaId(publicidad);
                
                if (categoriaPubId !== null) {
                    return Number(categoriaPubId) === Number(categoriaId);
                }
                
                return false;
            });
            
            const { empresas, talentos } = separarEmpresasYTalentos(publicidadesFiltradas);
            
            renderFilteredContent(empresas, talentos, categoria);
        }

        // Mostrar todas las categor√≠as (sin filtro)
        function showAllCategories() {
            if (!requireLogin()) return;
            
            // Limpiar b√∫squeda si est√° activa
            if (busquedaActiva) {
                clearSearch();
            }
            
            categoriaSeleccionada = null;
            
            updateCategoryUI('all');
            
            renderHomeContent();
        }

        // Actualizar la UI de categor√≠as
        function updateCategoryUI(categoriaIdSeleccionada) {
            document.querySelectorAll('.category-filter').forEach(item => {
                item.classList.remove('category-active');
            });
            
            const categoriaSeleccionadaElement = document.querySelector(`[data-categoria-id="${categoriaIdSeleccionada}"]`);
            if (categoriaSeleccionadaElement) {
                categoriaSeleccionadaElement.classList.add('category-active');
            }
            
            if (categoriaIdSeleccionada === 'all') {
                document.getElementById('backToAllContainer').style.display = 'none';
                document.getElementById('categoryTitleContainer').style.display = 'none';
                document.getElementById('categoryFilterText').style.display = 'none';
            } else {
                document.getElementById('backToAllContainer').style.display = 'block';
                document.getElementById('categoryTitleContainer').style.display = 'block';
                document.getElementById('categoryFilterText').style.display = 'inline';
                document.getElementById('categoryTitle').textContent = `${getCategoryIcon(categoriaSeleccionada.nombre_categoria)} ${categoriaSeleccionada.nombre_categoria}`;
                document.getElementById('categoryName').textContent = categoriaSeleccionada.nombre_categoria;
            }
        }

        // Renderizar contenido filtrado
        function renderFilteredContent(empresas, talentos, categoria) {
            updateResultsCounter(empresas, talentos, categoria);
            
            renderEmpresasFiltradas(empresas, categoria);
            
            renderTalentosFiltrados(talentos, categoria);
        }

        // Actualizar contador de resultados
        function updateResultsCounter(empresas, talentos, categoria) {
            const total = empresas.length + talentos.length;
            
            document.getElementById('totalResults').textContent = total;
            document.getElementById('empresasCount').textContent = empresas.length;
            document.getElementById('talentosCount').textContent = talentos.length;
            
            if (categoria) {
                document.getElementById('categoryFilterText').style.display = 'inline';
                document.getElementById('categoryName').textContent = categoria.nombre_categoria;
            } else if (busquedaActiva) {
                document.getElementById('categoryFilterText').style.display = 'inline';
                document.getElementById('categoryName').textContent = `"${terminoBusqueda}"`;
            } else {
                document.getElementById('categoryFilterText').style.display = 'none';
            }
        }

        // Renderizar empresas/servicios filtrados
        function renderEmpresasFiltradas(empresas, categoria) {
            const container = document.getElementById('empresasContainer');
            
            if (empresas.length === 0) {
                let mensaje = 'üè¢ No hay empresas disponibles';
                let subtitulo = 'Intenta con otra b√∫squeda o categor√≠a.';
                
                if (categoria && busquedaActiva) {
                    mensaje = `üè¢ No se encontraron empresas para "${terminoBusqueda}"`;
                    subtitulo = `en la categor√≠a "${categoria.nombre_categoria}"`;
                } else if (categoria) {
                    mensaje = `üè¢ No hay empresas en la categor√≠a "${categoria.nombre_categoria}"`;
                } else if (busquedaActiva) {
                    mensaje = `üè¢ No se encontraron empresas para "${terminoBusqueda}"`;
                }
                
                container.innerHTML = `
                    <div class="col-12">
                        <div class="no-results">
                            <h5>${mensaje}</h5>
                            <p class="text-muted">${subtitulo}</p>
                        </div>
                    </div>
                `;
                return;
            }

            let empresasHTML = '';
            
            empresas.forEach(publicidad => {
                const categoriaNombre = getNombreCategoria(publicidad);
                const nombreUsuario = getNombreUsuario(publicidad);
                const promedio = calcularPromedioCalificaciones(publicidad.id_publicidad, 'empresa');
                
                empresasHTML += `
                    <div class="col-md-6 mb-3">
                        <div class="card empresa-card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="card-title mb-0">${publicidad.titulo_publicidad}</h6>
                                <span class="badge badge-empresa">Empresa</span>
                            </div>
                            <div class="card-body">
                                <p class="card-text text-muted text-truncate-3">
                                    ${publicidad.descripcion_detallada}
                                </p>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <span class="badge bg-success">${categoriaNombre}</span>
                                    ${promedio > 0 ? `
                                        <div class="average-rating">
                                            <span class="text-warning">‚≠ê ${promedio}</span>
                                            <small class="text-muted">(${calificacionesEmpresasData[publicidad.id_publicidad]?.length || 0})</small>
                                        </div>
                                    ` : '<small class="text-muted">‚≠ê Sin calificaciones</small>'}
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <small class="text-muted">Publicado por: ${nombreUsuario}</small>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <small class="text-muted">${formatDate(publicidad.fecha_publicacion)}</small>
                                </div>
                            </div>
                            <div class="card-footer bg-white border-0">
                                <button class="btn btn-outline-secondary btn-sm" onclick="showEmpresaDetails(${publicidad.id_publicidad})">
                                    M√°s Informaci√≥n
                                </button>
                                <button class="btn btn-rating btn-sm" onclick="showEmpresaRatingModal(${publicidad.id_publicidad})">
                                    ‚≠ê Calificar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = empresasHTML;
        }

        // Renderizar talentos humanos filtrados
        function renderTalentosFiltrados(talentos, categoria) {
            const container = document.getElementById('talentosContainer');
            
            if (talentos.length === 0) {
                let mensaje = 'üë• No hay talentos disponibles';
                let subtitulo = 'Intenta con otra b√∫squeda o categor√≠a.';
                
                if (categoria && busquedaActiva) {
                    mensaje = `üë• No se encontraron talentos para "${terminoBusqueda}"`;
                    subtitulo = `en la categor√≠a "${categoria.nombre_categoria}"`;
                } else if (categoria) {
                    mensaje = `üë• No hay talentos en la categor√≠a "${categoria.nombre_categoria}"`;
                } else if (busquedaActiva) {
                    mensaje = `üë• No se encontraron talentos para "${terminoBusqueda}"`;
                }
                
                container.innerHTML = `
                    <div class="col-12">
                        <div class="no-results">
                            <h5>${mensaje}</h5>
                            <p class="text-muted">${subtitulo}</p>
                        </div>
                    </div>
                `;
                return;
            }

            let talentosHTML = '';
            
            talentos.forEach(publicidad => {
                const categoriaNombre = getNombreCategoria(publicidad);
                const nombreUsuario = getNombreUsuario(publicidad);
                const promedio = calcularPromedioCalificaciones(publicidad.id_publicidad, 'talento');
                
                talentosHTML += `
                    <div class="col-md-4 mb-3">
                        <div class="card talent-card h-100">
                            <div class="card-body">
                                <h6 class="card-title">${publicidad.titulo_publicidad}</h6>
                                <p class="card-text small text-muted text-truncate-3">
                                    ${publicidad.descripcion_detallada}
                                </p>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="badge bg-info text-dark">${categoriaNombre}</span>
                                    ${promedio > 0 ? `
                                        <div class="average-rating">
                                            <span class="text-warning">‚≠ê ${promedio}</span>
                                            <small class="text-muted">(${calificacionesData[publicidad.id_publicidad]?.length || 0})</small>
                                        </div>
                                    ` : '<small class="text-muted">‚≠ê Sin calificaciones</small>'}
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted"><strong>Publicado por:</strong> ${nombreUsuario}</small>
                                </div>
                            </div>
                            <div class="card-footer bg-white border-0">
                                <button class="btn btn-outline-secondary btn-sm" onclick="showTalentoDetails(${publicidad.id_publicidad})">
                                    M√°s Informaci√≥n
                                </button>
                                <button class="btn btn-rating btn-sm" onclick="showRatingModal(${publicidad.id_publicidad})">
                                    ‚≠ê Calificar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = talentosHTML;
        }

        // Renderizar contenido del home (todas las categor√≠as)
        function renderHomeContent() {
            const { empresas, talentos } = separarEmpresasYTalentos(publicidadesData);
            
            updateResultsCounter(empresas, talentos, null);
            
            renderEmpresas(empresas);
            renderTalentos(talentos);
        }

        // Renderizar empresas/servicios (todas las categor√≠as)
        function renderEmpresas(empresas) {
            const container = document.getElementById('empresasContainer');
            
            if (empresas.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center">
                        <p class="text-muted">No hay empresas disponibles en este momento.</p>
                    </div>
                `;
                return;
            }

            let empresasHTML = '';
            
            empresas.forEach(publicidad => {
                const categoriaNombre = getNombreCategoria(publicidad);
                const nombreUsuario = getNombreUsuario(publicidad);
                const promedio = calcularPromedioCalificaciones(publicidad.id_publicidad, 'empresa');
                
                empresasHTML += `
                    <div class="col-md-6 mb-3">
                        <div class="card empresa-card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="card-title mb-0">${publicidad.titulo_publicidad}</h6>
                                <span class="badge badge-empresa">Empresa</span>
                            </div>
                            <div class="card-body">
                                <p class="card-text text-muted text-truncate-3">
                                    ${publicidad.descripcion_detallada}
                                </p>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <span class="badge bg-success">${categoriaNombre}</span>
                                    ${promedio > 0 ? `
                                        <div class="average-rating">
                                            <span class="text-warning">‚≠ê ${promedio}</span>
                                            <small class="text-muted">(${calificacionesEmpresasData[publicidad.id_publicidad]?.length || 0})</small>
                                        </div>
                                    ` : '<small class="text-muted">‚≠ê Sin calificaciones</small>'}
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <small class="text-muted">Publicado por: ${nombreUsuario}</small>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <small class="text-muted">${formatDate(publicidad.fecha_publicacion)}</small>
                                </div>
                            </div>
                            <div class="card-footer bg-white border-0">
                                <button class="btn btn-outline-secondary btn-sm" onclick="showEmpresaDetails(${publicidad.id_publicidad})">
                                    M√°s Informaci√≥n
                                </button>
                                <button class="btn btn-rating btn-sm" onclick="showEmpresaRatingModal(${publicidad.id_publicidad})">
                                    ‚≠ê Calificar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = empresasHTML;
        }

        // Renderizar talentos humanos (todas las categor√≠as)
        function renderTalentos(talentos) {
            const container = document.getElementById('talentosContainer');
            
            if (talentos.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center">
                        <p class="text-muted">No hay talentos disponibles en este momento.</p>
                    </div>
                `;
                return;
            }

            let talentosHTML = '';
            
            talentos.forEach(publicidad => {
                const categoriaNombre = getNombreCategoria(publicidad);
                const nombreUsuario = getNombreUsuario(publicidad);
                const promedio = calcularPromedioCalificaciones(publicidad.id_publicidad, 'talento');
                
                talentosHTML += `
                    <div class="col-md-4 mb-3">
                        <div class="card talent-card h-100">
                            <div class="card-body">
                                <h6 class="card-title">${publicidad.titulo_publicidad}</h6>
                                <p class="card-text small text-muted text-truncate-3">
                                    ${publicidad.descripcion_detallada}
                                </p>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="badge bg-info text-dark">${categoriaNombre}</span>
                                    ${promedio > 0 ? `
                                        <div class="average-rating">
                                            <span class="text-warning">‚≠ê ${promedio}</span>
                                            <small class="text-muted">(${calificacionesData[publicidad.id_publicidad]?.length || 0})</small>
                                        </div>
                                    ` : '<small class="text-muted">‚≠ê Sin calificaciones</small>'}
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted"><strong>Publicado por:</strong> ${nombreUsuario}</small>
                                </div>
                            </div>
                            <div class="card-footer bg-white border-0">
                                <button class="btn btn-outline-secondary btn-sm" onclick="showTalentoDetails(${publicidad.id_publicidad})">
                                    M√°s Informaci√≥n
                                </button>
                                <button class="btn btn-rating btn-sm" onclick="showRatingModal(${publicidad.id_publicidad})">
                                    ‚≠ê Calificar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = talentosHTML;
        }

        // Funci√≥n para obtener icono seg√∫n categor√≠a
        function getCategoryIcon(categoriaNombre) {
            const iconMap = {
                'electricidad': '‚ö°',
                'construcci√≥n': 'üß±',
                'plomer√≠a': 'üîß',
                'carpinter√≠a': 'üõ†Ô∏è',
                'refrigeraci√≥n': '‚ùÑÔ∏è',
                'mec√°nica': 'üöó',
                'turismo': 'üß≥',
                'limpieza': 'üè°',
                'reposter√≠a': 'üéÇ',
                'educaci√≥n': 'üéì',
                'cuidado': 'üë∂',
                'belleza': 'üíá',
                'programaci√≥n': 'üíª',
                'dise√±o': 'üé®',
                'general': 'üîÆ'
            };

            for (const [key, icon] of Object.entries(iconMap)) {
                if (categoriaNombre.toLowerCase().includes(key)) {
                    return icon;
                }
            }
            return 'üîÆ';
        }

        // Funci√≥n para formatear fecha
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                return date.toLocaleDateString('es-ES', options);
            } catch (error) {
                return 'Fecha no disponible';
            }
        }

        // VERIFICACI√ìN DE AUTENTICACI√ìN
        async function checkAuthentication() {
            const token = localStorage.getItem('access_token');
            
            if (!token) {
                showPublicUI();
                return;
            }

            try {
                const response = await Promise.race([
                    fetch(`${BACKEND_URL}/auth/user-profile/`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout')), 3000)
                    )
                ]);

                if (response.ok) {
                    showAuthenticatedUI();
                } else {
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    localStorage.removeItem('user_data');
                    showPublicUI();
                }
                
            } catch (error) {
                showPublicUI();
            }
        }

        function showAuthenticatedUI() {
            const userData = localStorage.getItem('user_data');
            let userName = 'Usuario';
            
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    userName = user.nombre_completo || user.correo_electronico || 'Usuario';
                } catch (e) {}
            }
            
            document.getElementById('userWelcome').textContent = `üëã Bienvenido, ${userName}`;
            document.getElementById('authButtons').style.display = 'none';
            document.getElementById('userMenu').style.display = 'flex';
            document.querySelectorAll('.login-badge').forEach(badge => {
                badge.style.display = 'none';
            });
            document.getElementById('publicContent').style.display = 'none';
        }

        function showPublicUI() {
            document.getElementById('userWelcome').textContent = 'üëã Bienvenido a WORKLY';
            document.getElementById('authButtons').style.display = 'block';
            document.getElementById('userMenu').style.display = 'none';
            document.querySelectorAll('.login-badge').forEach(badge => {
                badge.style.display = 'block';
            });
            document.getElementById('publicContent').style.display = 'flex';
        }

        function toggleMoreCategories() {
            const moreCategories = document.getElementById('moreCategories');
            const button = document.querySelector('.show-more-btn');
            
            if (moreCategories.style.display === 'none' || moreCategories.style.display === '') {
                moreCategories.style.display = 'block';
                button.textContent = 'üìÇ Ver menos categor√≠as';
            } else {
                moreCategories.style.display = 'none';
                button.textContent = 'üìÇ Ver m√°s categor√≠as';
            }
        }

        function requireLogin() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                loginRequiredModal.show();
                return false;
            }
            return true;
        }

        // Funci√≥n para mostrar detalles de empresa/servicio
        function showEmpresaDetails(publicidadId) {
            if (!requireLogin()) return;
            
            const publicidad = publicidadesData.find(p => p.id_publicidad === publicidadId);
            if (!publicidad) {
                showError('No se encontr√≥ la informaci√≥n del servicio');
                return;
            }
            
            const categoriaNombre = getNombreCategoria(publicidad);
            const nombreUsuario = getNombreUsuario(publicidad);
            const calificaciones = calificacionesEmpresasData[publicidadId] || [];
            const promedio = calcularPromedioCalificaciones(publicidadId, 'empresa');
            
            let contactoUsuario = 'No especificado';
            let fechaPublicacion = 'No especificada';
            
            let usuarioId = publicidad.id_usuario_id || publicidad.id_usuario || publicidad.usuario_id;
            
            if (usuarioId && usuariosData[usuarioId]) {
                const usuario = usuariosData[usuarioId];
                contactoUsuario = usuario.telefono_contacto || usuario.telefono || usuario.celular || 
                                 usuario.phone || usuario.phone_number || 'No especificado';
            }
            
            fechaPublicacion = formatDate(publicidad.fecha_publicacion) || 'No especificada';
            
            const modalContent = `
                <div class="info-item">
                    <div class="info-label">Nombre del servicio</div>
                    <div class="info-value">${publicidad.titulo_publicidad}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Categor√≠a</div>
                    <div class="info-value">${categoriaNombre}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Contacto</div>
                    <div class="info-value">${contactoUsuario}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Ubicaci√≥n</div>
                    <div class="info-value">${publicidad.ubicacion || 'No especificada'}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Fecha de publicaci√≥n</div>
                    <div class="info-value">${fechaPublicacion}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Descripci√≥n</div>
                    <div class="info-value">${publicidad.descripcion_detallada || 'Servicio profesional de calidad'}</div>
                </div>
                
                ${promedio > 0 ? `
                <div class="info-item">
                    <div class="info-label">Calificaci√≥n promedio</div>
                    <div class="info-value">
                        <div class="average-rating">
                            <span class="text-warning" style="font-size: 1.2rem;">‚≠ê ${promedio}</span>
                            <small class="text-muted">(${calificaciones.length} calificaciones)</small>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                ${calificaciones.length > 0 ? `
                <div class="info-item">
                    <div class="info-label">Calificaciones anteriores</div>
                    <div id="calificacionesList">
                        ${calificaciones.map(calificacion => `
                            <div class="rating-item">
                                <div class="rating-user">${calificacion.usuario}</div>
                                <div class="rating-stars small">
                                    ${'‚òÖ'.repeat(calificacion.rating)}${'‚òÜ'.repeat(5 - calificacion.rating)}
                                </div>
                                <div class="rating-date">${calificacion.fecha}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            `;
            
            document.getElementById('empresaDetailsContent').innerHTML = modalContent;
            document.getElementById('empresaDetailsModalLabel').textContent = publicidad.titulo_publicidad;
            
            empresaDetailsModal.show();
        }

        // Funci√≥n para mostrar detalles de talento
        function showTalentoDetails(publicidadId) {
            if (!requireLogin()) return;
            
            const publicidad = publicidadesData.find(p => p.id_publicidad === publicidadId);
            if (!publicidad) {
                showError('No se encontr√≥ la informaci√≥n del talento');
                return;
            }
            
            const categoriaNombre = getNombreCategoria(publicidad);
            const nombreUsuario = getNombreUsuario(publicidad);
            const calificaciones = calificacionesData[publicidadId] || [];
            const promedio = calcularPromedioCalificaciones(publicidadId, 'talento');
            
            let contactoUsuario = 'No especificado';
            let fechaPublicacion = 'No especificada';
            
            let usuarioId = publicidad.id_usuario_id || publicidad.id_usuario || publicidad.usuario_id;
            
            if (usuarioId && usuariosData[usuarioId]) {
                const usuario = usuariosData[usuarioId];
                contactoUsuario = usuario.telefono_contacto || usuario.telefono || usuario.celular || 
                                 usuario.phone || usuario.phone_number || 'No especificado';
            }
            
            fechaPublicacion = formatDate(publicidad.fecha_publicacion) || 'No especificada';
            
            const modalContent = `
                <div class="info-item">
                    <div class="info-label">Nombre del talento</div>
                    <div class="info-value">${publicidad.titulo_publicidad}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Categor√≠a</div>
                    <div class="info-value">${categoriaNombre}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Contacto</div>
                    <div class="info-value">${contactoUsuario}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Ubicaci√≥n</div>
                    <div class="info-value">${publicidad.ubicacion || 'No especificada'}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Fecha de publicaci√≥n</div>
                    <div class="info-value">${fechaPublicacion}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Descripci√≥n</div>
                    <div class="info-value">${publicidad.descripcion_detallada || 'Profesional de calidad'}</div>
                </div>
                
                ${promedio > 0 ? `
                <div class="info-item">
                    <div class="info-label">Calificaci√≥n promedio</div>
                    <div class="info-value">
                        <div class="average-rating">
                            <span class="text-warning" style="font-size: 1.2rem;">‚≠ê ${promedio}</span>
                            <small class="text-muted">(${calificaciones.length} calificaciones)</small>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                ${calificaciones.length > 0 ? `
                <div class="info-item">
                    <div class="info-label">Calificaciones anteriores</div>
                    <div id="calificacionesList">
                        ${calificaciones.map(calificacion => `
                            <div class="rating-item">
                                <div class="rating-user">${calificacion.usuario}</div>
                                <div class="rating-stars small">
                                    ${'‚òÖ'.repeat(calificacion.rating)}${'‚òÜ'.repeat(5 - calificacion.rating)}
                                </div>
                                <div class="rating-date">${calificacion.fecha}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            `;
            
            document.getElementById('talentoDetailsContent').innerHTML = modalContent;
            document.getElementById('talentoDetailsModalLabel').textContent = publicidad.titulo_publicidad;
            
            talentoDetailsModal.show();
        }

        // Funci√≥n para mostrar modal de calificaci√≥n de empresa
        function showEmpresaRatingModal(publicidadId) {
            if (!requireLogin()) return;
            
            const publicidad = publicidadesData.find(p => p.id_publicidad === publicidadId);
            if (!publicidad) {
                showError('No se encontr√≥ la informaci√≥n de la empresa');
                return;
            }
            
            currentPublicidadId = publicidadId;
            currentRating = 0;
            currentRatingType = 'empresa';
            
            const modalContent = `
                <div class="text-center">
                    <h6>Calificar a: ${publicidad.titulo_publicidad}</h6>
                    <p class="text-muted">Selecciona de 1 a 5 estrellas</p>
                    
                    <div class="rating-stars mb-3" id="ratingStars">
                        <span class="star" data-rating="1">‚òÜ</span>
                        <span class="star" data-rating="2">‚òÜ</span>
                        <span class="star" data-rating="3">‚òÜ</span>
                        <span class="star" data-rating="4">‚òÜ</span>
                        <span class="star" data-rating="5">‚òÜ</span>
                    </div>
                    
                    <div id="ratingValue" class="text-muted">Selecciona una calificaci√≥n</div>
                </div>
            `;
            
            document.getElementById('ratingEmpresaContent').innerHTML = modalContent;
            document.getElementById('ratingEmpresaModalLabel').textContent = `Calificar: ${publicidad.titulo_publicidad}`;
            
            setupRatingSystem();
            
            document.getElementById('confirmEmpresaRatingBtn').onclick = function() {
                if (currentRating === 0) {
                    showError('Por favor selecciona una calificaci√≥n');
                    return;
                }
                guardarCalificacion();
            };
            
            ratingEmpresaModal.show();
        }

        // Funci√≥n para mostrar modal de calificaci√≥n de talento
        function showRatingModal(publicidadId) {
            if (!requireLogin()) return;
            
            const publicidad = publicidadesData.find(p => p.id_publicidad === publicidadId);
            if (!publicidad) {
                showError('No se encontr√≥ la informaci√≥n del talento');
                return;
            }
            
            currentPublicidadId = publicidadId;
            currentRating = 0;
            currentRatingType = 'talento';
            
            const modalContent = `
                <div class="text-center">
                    <h6>Calificar a: ${publicidad.titulo_publicidad}</h6>
                    <p class="text-muted">Selecciona de 1 a 5 estrellas</p>
                    
                    <div class="rating-stars mb-3" id="ratingStars">
                        <span class="star" data-rating="1">‚òÜ</span>
                        <span class="star" data-rating="2">‚òÜ</span>
                        <span class="star" data-rating="3">‚òÜ</span>
                        <span class="star" data-rating="4">‚òÜ</span>
                        <span class="star" data-rating="5">‚òÜ</span>
                    </div>
                    
                    <div id="ratingValue" class="text-muted">Selecciona una calificaci√≥n</div>
                </div>
            `;
            
            document.getElementById('ratingContent').innerHTML = modalContent;
            document.getElementById('ratingModalLabel').textContent = `Calificar: ${publicidad.titulo_publicidad}`;
            
            setupRatingSystem();
            
            document.getElementById('confirmRatingBtn').onclick = function() {
                if (currentRating === 0) {
                    showError('Por favor selecciona una calificaci√≥n');
                    return;
                }
                guardarCalificacion();
            };
            
            ratingModal.show();
        }

        // Configurar el sistema de calificaci√≥n con estrellas
        function setupRatingSystem() {
            const stars = document.querySelectorAll('.star');
            const ratingValue = document.getElementById('ratingValue');
            
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    currentRating = rating;
                    
                    stars.forEach((s, index) => {
                        if (index < rating) {
                            s.textContent = '‚òÖ';
                            s.style.color = '#ffc107';
                        } else {
                            s.textContent = '‚òÜ';
                            s.style.color = '#ffc107';
                        }
                    });
                    
                    ratingValue.textContent = `Has seleccionado ${rating} estrella${rating > 1 ? 's' : ''}`;
                    ratingValue.style.color = '#495057';
                });
                
                star.addEventListener('mouseover', function() {
                    const hoverRating = parseInt(this.getAttribute('data-rating'));
                    
                    stars.forEach((s, index) => {
                        if (index < hoverRating) {
                            s.style.color = '#ffc107';
                        } else {
                            s.style.color = '#e0e0e0';
                        }
                    });
                });
                
                star.addEventListener('mouseout', function() {
                    stars.forEach((s, index) => {
                        if (index < currentRating) {
                            s.style.color = '#ffc107';
                        } else {
                            s.style.color = '#ffc107';
                        }
                    });
                });
            });
        }

        // Funci√≥n para guardar calificaci√≥n
        function guardarCalificacion() {
            const userData = localStorage.getItem('user_data');
            let userName = 'Usuario An√≥nimo';
            
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    userName = user.nombre_completo || user.correo_electronico || 'Usuario';
                } catch (e) {}
            }
            
            const nuevaCalificacion = {
                rating: currentRating,
                usuario: userName,
                fecha: new Date().toLocaleDateString('es-ES')
            };
            
            const calificacionesTarget = currentRatingType === 'empresa' 
                ? calificacionesEmpresasData 
                : calificacionesData;
            
            if (!calificacionesTarget[currentPublicidadId]) {
                calificacionesTarget[currentPublicidadId] = [];
            }
            
            const calificacionExistenteIndex = calificacionesTarget[currentPublicidadId].findIndex(
                cal => cal.usuario === userName
            );
            
            if (calificacionExistenteIndex !== -1) {
                calificacionesTarget[currentPublicidadId][calificacionExistenteIndex] = nuevaCalificacion;
            } else {
                calificacionesTarget[currentPublicidadId].push(nuevaCalificacion);
            }
            
            localStorage.setItem('workly_calificaciones', JSON.stringify(calificacionesData));
            localStorage.setItem('workly_calificaciones_empresas', JSON.stringify(calificacionesEmpresasData));
            
            if (currentRatingType === 'empresa') {
                ratingEmpresaModal.hide();
            } else {
                ratingModal.hide();
            }
            
            showSuccess('¬°Calificaci√≥n guardada exitosamente!');
            
            // Refrescar la vista actual
            if (busquedaActiva) {
                handleSearch({target: {value: terminoBusqueda}});
            } else if (categoriaSeleccionada) {
                filterByCategory(categoriaSeleccionada.id_categoria || categoriaSeleccionada.id);
            } else {
                renderHomeContent();
            }
        }

        function showSuccess(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }

        function showCategoryPage(categoriaId) {
            if (requireLogin()) {
                filterByCategory(categoriaId);
            }
        }

        function showMainPage() {
            document.getElementById('mainPage').style.display = 'block';
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_data');
            window.location.href = "/logout/";
        }

        function showError(message) {
            alert(`‚ùå Error: ${message}`);
        }
    </script>
</body>
</html>