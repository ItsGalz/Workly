<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WORKLY - Servicios Disponibles</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
            color: #2c3e50 !important;
        }
        .hero-section {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 2.5rem 0;
        }
        .category-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
            background: white;
        }
        .category-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .service-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
            transition: all 0.3s ease;
            background: white;
        }
        .service-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .talent-card {
            border-left: 4px solid #3498db;
            background: #f8f9fa;
        }
        .empresa-card {
            border-left: 4px solid #27ae60;
            background: #f8f9fa;
        }
        .btn-workly {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            border: none;
            color: white;
            font-weight: 500;
        }
        .btn-workly:hover {
            background: linear-gradient(135deg, #34495e 0%, #2980b9 100%);
            color: white;
        }
        .user-welcome {
            color: #2c3e50;
            font-weight: 500;
        }
        .card-header {
            background: white !important;
            border-bottom: 1px solid #e9ecef;
            color: #2c3e50;
        }
        .login-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        .more-categories {
            display: none;
        }
        .show-more-btn {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 5px 0;
        }
        .show-more-btn:hover {
            text-decoration: underline;
        }
        .text-truncate-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .category-active {
            background-color: #3498db !important;
            color: white !important;
            font-weight: bold;
        }
        .category-filter {
            cursor: pointer;
        }
        .no-results {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        .back-to-all {
            margin-bottom: 1rem;
        }
        .results-counter {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 20px;
        }
        .badge-empresa {
            background-color: #27ae60;
        }
        .badge-talento {
            background-color: #3498db;
        }
        .rating-stars {
            color: #ffc107;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .rating-stars .star {
            transition: all 0.2s ease;
        }
        .rating-stars .star:hover {
            transform: scale(1.2);
        }
        .info-item {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        .info-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .info-value {
            color: #495057;
        }
        .rating-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #3498db;
        }
        .rating-user {
            font-weight: 600;
            color: #2c3e50;
        }
        .rating-date {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .card-footer {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn-rating {
            background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);
            border: none;
            color: white;
        }
        .btn-rating:hover {
            background: linear-gradient(135deg, #e0a800 0%, #e67e00 100%);
            color: white;
        }
        .average-rating {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p>Verificando autenticaci√≥n...</p>
        </div>
    </div>

    <!-- Modal para requerir login -->
    <div class="modal fade" id="loginRequiredModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üîê Inicio de Sesi√≥n Requerido</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Para acceder a esta funci√≥n necesitas iniciar sesi√≥n en tu cuenta.</p>
                    <div class="alert alert-info">
                        <small>¬øNo tienes cuenta? <a href="/register/" class="alert-link">Reg√≠strate gratis</a></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <a href="/login/" class="btn btn-workly">Iniciar Sesi√≥n</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalles de empresa/servicio -->
    <div class="modal fade" id="empresaDetailsModal" tabindex="-1" aria-labelledby="empresaDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="empresaDetailsModalLabel">Detalles del Servicio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="empresaDetailsContent">
                    <!-- Contenido din√°mico se cargar√° aqu√≠ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalles de talento -->
    <div class="modal fade" id="talentoDetailsModal" tabindex="-1" aria-labelledby="talentoDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="talentoDetailsModalLabel">Detalles del Talento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="talentoDetailsContent">
                    <!-- Contenido din√°mico se cargar√° aqu√≠ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para calificar -->
    <div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="ratingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ratingModalLabel">Calificar Talento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="ratingContent">
                    <!-- Contenido din√°mico se cargar√° aqu√≠ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-workly" id="confirmRatingBtn">Confirmar Calificaci√≥n</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para calificar empresa -->
    <div class="modal fade" id="ratingEmpresaModal" tabindex="-1" aria-labelledby="ratingEmpresaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ratingEmpresaModalLabel">Calificar Empresa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="ratingEmpresaContent">
                    <!-- Contenido din√°mico se cargar√° aqu√≠ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-workly" id="confirmEmpresaRatingBtn">Confirmar Calificaci√≥n</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
        <div class="container">
            <a class="navbar-brand" href="/">üöÄ WORKLY</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3 user-welcome" id="userWelcome">
                    üëã Bienvenido a WORKLY
                </span>
                <div id="authButtons">
                    <a href="/login/" class="btn btn-workly btn-sm me-2">Iniciar Sesi√≥n</a>
                    <a href="/register/" class="btn btn-outline-dark btn-sm">Registrarse</a>
                </div>
                <div id="userMenu" style="display: none;">
                    <a href="/publicarme/" class="btn btn-workly btn-sm me-2">üìù Publicarme</a>
                    <a href="/profile/" class="btn btn-outline-primary btn-sm me-2">Mi Perfil</a>
                    <button class="btn btn-outline-dark btn-sm" onclick="logout()">Cerrar Sesi√≥n</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- P√°gina Principal -->
    <div id="mainPage" style="display: none;">
        <!-- Hero Section -->
        <section class="hero-section">
            <div class="container text-center">
                <h1 class="display-5 fw-bold">Servicios Disponibles</h1>
                <p class="lead">Encuentra los mejores profesionales y servicios en WORKLY</p>
            </div>
        </section>

        <!-- Main Content -->
        <div class="container my-5">
            <div class="row">
                <!-- Sidebar - Categor√≠as -->
                <div class="col-lg-3 mb-4">
                    <div class="card category-card">
                        <div class="card-header">
                            <h5 class="mb-0">üìã Categor√≠as</h5>
                        </div>
                        <div class="card-body">
                            <div class="list-group list-group-flush" id="categoriesList">
                                <div class="text-center">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Cargando categor√≠as...</span>
                                    </div>
                                    <small class="text-muted">Cargando categor√≠as...</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content - Servicios -->
                <div class="col-lg-9">
                    <!-- Contenido P√∫blico (siempre visible) -->
                    <div class="row" id="publicContent">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <strong>üí° Explora nuestros servicios:</strong> Puedes ver toda la informaci√≥n. <strong>Inicia sesi√≥n</strong> para ver m√°s detalles y categor√≠as espec√≠ficas.
                            </div>
                        </div>
                    </div>

                    <!-- Bot√≥n para volver a todas las categor√≠as (oculto inicialmente) -->
                    <div class="row mb-3" id="backToAllContainer" style="display: none;">
                        <div class="col-12">
                            <button class="btn btn-outline-primary btn-sm back-to-all" onclick="showAllCategories()">
                                ‚Üê Volver a todas las categor√≠as
                            </button>
                        </div>
                    </div>

                    <!-- T√≠tulo de categor√≠a seleccionada -->
                    <div class="row mb-4" id="categoryTitleContainer" style="display: none;">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0" id="categoryTitle">Categor√≠a Seleccionada</h5>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contador de resultados -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="results-counter">
                                <small class="text-muted" id="resultsCounter">
                                    <strong id="totalResults">0</strong> servicios encontrados
                                    <span id="categoryFilterText" style="display: none;"> en <strong id="categoryName"></strong></span>
                                    <span class="float-end">
                                        <strong id="empresasCount">0</strong> empresas ‚Ä¢ 
                                        <strong id="talentosCount">0</strong> talentos
                                    </span>
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Empresas/Servicios Destacados -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">üè¢ Servicios y Empresas Destacadas</h5>
                                    <span class="badge badge-empresa">Empresas</span>
                                </div>
                                <div class="card-body">
                                    <div class="row" id="empresasContainer">
                                        <div class="col-12 text-center">
                                            <div class="spinner-border" role="status">
                                                <span class="visually-hidden">Cargando servicios...</span>
                                            </div>
                                            <p class="text-muted mt-2">Cargando servicios disponibles...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Talentos Humanos Disponibles -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">üë• Talentos Humanos Disponibles</h5>
                                    <span class="badge badge-talento">Talentos</span>
                                </div>
                                <div class="card-body">
                                    <div class="row" id="talentosContainer">
                                        <div class="col-12 text-center">
                                            <div class="spinner-border" role="status">
                                                <span class="visually-hidden">Cargando talentos...</span>
                                            </div>
                                            <p class="text-muted mt-2">Cargando talentos disponibles...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>üöÄ WORKLY</h5>
                    <p class="text-muted">Tu plataforma de confianza para servicios profesionales</p>
                </div>
                <div class="col-md-6 text-end">
                    <p class="text-muted">&copy; 2024 WORKLY. Todos los derechos reservados.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // URLs CONFIGURADAS
        const BACKEND_URL = 'http://127.0.0.1:8001';

        // Modales de Bootstrap
        const loginRequiredModal = new bootstrap.Modal(document.getElementById('loginRequiredModal'));
        const empresaDetailsModal = new bootstrap.Modal(document.getElementById('empresaDetailsModal'));
        const talentoDetailsModal = new bootstrap.Modal(document.getElementById('talentoDetailsModal'));
        const ratingModal = new bootstrap.Modal(document.getElementById('ratingModal'));
        const ratingEmpresaModal = new bootstrap.Modal(document.getElementById('ratingEmpresaModal'));

        // Variables globales
        let categoriasData = [];
        let publicidadesData = [];
        let usuariosData = {};
        let categoriaSeleccionada = null;
        let currentRating = 0;
        let currentPublicidadId = null;
        let currentRatingType = null; // 'talento' o 'empresa'
        
        // Almacenamiento de calificaciones (simulado - en producci√≥n usar√≠as una base de datos)
        let calificacionesData = JSON.parse(localStorage.getItem('workly_calificaciones')) || {};
        let calificacionesEmpresasData = JSON.parse(localStorage.getItem('workly_calificaciones_empresas')) || {};

        // Verificar autenticaci√≥n ANTES de cargar la p√°gina
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuthentication();
            // Una vez verificada la autenticaci√≥n, mostrar la p√°gina y cargar datos
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('mainPage').style.display = 'block';
            loadInitialData();
        });

        // Cargar datos iniciales
        async function loadInitialData() {
            try {
                await Promise.all([
                    loadCategorias(),
                    loadPublicidades(),
                    loadUsuarios()
                ]);
                renderHomeContent();
            } catch (error) {
                console.error('Error cargando datos iniciales:', error);
                showError('Error al cargar los datos');
            }
        }

        // Funci√≥n para determinar si es Empresa o Talento
        function esEmpresa(publicidad) {
            // Basado en el t√≠tulo, descripci√≥n o campos espec√≠ficos
            const titulo = publicidad.titulo_publicidad ? publicidad.titulo_publicidad.toLowerCase() : '';
            const descripcion = publicidad.descripcion_detallada ? publicidad.descripcion_detallada.toLowerCase() : '';
            
            // Si el t√≠tulo contiene "empresa", "servicio", "compa√±√≠a", etc.
            const palabrasEmpresa = ['empresa', 'servicio', 'compa√±√≠a', 'company', 'business', 'corporaci√≥n'];
            const palabrasTalento = ['talento', 'freelance', 'independiente', 'personal', 'profesional'];
            
            // Verificar palabras de empresa
            for (let palabra of palabrasEmpresa) {
                if (titulo.includes(palabra) || descripcion.includes(palabra)) {
                    return true;
                }
            }
            
            // Verificar palabras de talento
            for (let palabra of palabrasTalento) {
                if (titulo.includes(palabra) || descripcion.includes(palabra)) {
                    return false;
                }
            }
            
            // Si no se puede determinar, usar el ID como criterio alternativo
            return publicidad.id_publicidad <= 3;
        }

        // Separar publicidades en Empresas y Talentos
        function separarEmpresasYTalentos(publicidades) {
            const empresas = [];
            const talentos = [];
            
            publicidades.forEach(publicidad => {
                if (esEmpresa(publicidad)) {
                    empresas.push(publicidad);
                } else {
                    talentos.push(publicidad);
                }
            });
            
            console.log(`üìä Separaci√≥n: ${empresas.length} empresas, ${talentos.length} talentos`);
            return { empresas, talentos };
        }

        // Cargar categor√≠as desde la API
        async function loadCategorias() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/categorias/`);
                if (!response.ok) throw new Error('Error al cargar categor√≠as');
                
                const data = await response.json();
                console.log('üìã Datos de categor√≠as recibidos:', data);
                
                // Manejar diferentes formatos de respuesta
                if (Array.isArray(data)) {
                    categoriasData = data;
                } else if (data.results && Array.isArray(data.results)) {
                    categoriasData = data.results;
                } else if (data.data && Array.isArray(data.data)) {
                    categoriasData = data.data;
                } else {
                    throw new Error('Formato de respuesta no reconocido');
                }
                
                console.log('üìã Categor√≠as procesadas:', categoriasData);
                renderCategorias();
            } catch (error) {
                console.error('Error cargando categor√≠as:', error);
                throw error;
            }
        }

        // Cargar publicidades desde la API
        async function loadPublicidades() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/publicidades/`);
                if (!response.ok) throw new Error('Error al cargar publicidades');
                
                const data = await response.json();
                console.log('üì¢ Datos de publicidades recibidos:', data);
                
                // Manejar diferentes formatos de respuesta
                if (Array.isArray(data)) {
                    publicidadesData = data;
                } else if (data.results && Array.isArray(data.results)) {
                    publicidadesData = data.results;
                } else if (data.data && Array.isArray(data.data)) {
                    publicidadesData = data.data;
                } else {
                    throw new Error('Formato de respuesta no reconocido');
                }
                
                console.log('üì¢ Publicidades procesadas:', publicidadesData);
                
            } catch (error) {
                console.error('Error cargando publicidades:', error);
                throw error;
            }
        }

        // Cargar usuarios desde la API - VERSI√ìN MEJORADA
        async function loadUsuarios() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/usuarios/`);
                if (!response.ok) throw new Error('Error al cargar usuarios');
                
                const data = await response.json();
                console.log('üë• Datos de usuarios recibidos:', data);
                
                // Manejar diferentes formatos de respuesta
                let usuariosArray = [];
                if (Array.isArray(data)) {
                    usuariosArray = data;
                } else if (data.results && Array.isArray(data.results)) {
                    usuariosArray = data.results;
                } else if (data.data && Array.isArray(data.data)) {
                    usuariosArray = data.data;
                } else {
                    console.log('‚ö†Ô∏è Formato de usuarios no reconocido, intentando extraer array');
                    // Intentar encontrar un array en el objeto
                    for (const key in data) {
                        if (Array.isArray(data[key])) {
                            usuariosArray = data[key];
                            break;
                        }
                    }
                }
                
                // Crear un objeto para f√°cil acceso por ID
                usuariosData = {};
                usuariosArray.forEach(usuario => {
                    const usuarioId = usuario.id_usuario || usuario.id || usuario.usuario_id;
                    if (usuarioId) {
                        usuariosData[usuarioId] = usuario;
                    }
                });
                
                console.log('üë• Usuarios procesados:', Object.keys(usuariosData).length, 'usuarios cargados');
                
            } catch (error) {
                console.error('Error cargando usuarios:', error);
                // Inicializar como objeto vac√≠o
                usuariosData = {};
            }
        }

        // Funci√≥n para obtener nombre de categor√≠a por ID - SOLUCI√ìN TEMPORAL
        function getNombreCategoria(publicidad) {
            // SOLUCI√ìN TEMPORAL: Extraer la categor√≠a del t√≠tulo
            // Los t√≠tulos tienen formato: "Talento: Nombre - Categor√≠a"
            const titulo = publicidad.titulo_publicidad;
            
            if (titulo && titulo.includes(' - ')) {
                const partes = titulo.split(' - ');
                if (partes.length > 1) {
                    const categoriaDelTitulo = partes[partes.length - 1];
                    return categoriaDelTitulo;
                }
            }
            
            // Si no se puede extraer del t√≠tulo, buscar en campos de categor√≠a
            let categoriaId = null;
            
            // Buscar en campos de categor√≠a
            if (publicidad.id_categoria !== undefined && publicidad.id_categoria !== null) {
                categoriaId = publicidad.id_categoria;
            } else if (publicidad.categoria_id !== undefined && publicidad.categoria_id !== null) {
                categoriaId = publicidad.categoria_id;
            } else if (publicidad.id_categoria_id !== undefined && publicidad.id_categoria_id !== null) {
                categoriaId = publicidad.id_categoria_id;
            } else if (publicidad.categoria && typeof publicidad.categoria === 'object') {
                categoriaId = publicidad.categoria.id_categoria || publicidad.categoria.id;
            }
            
            // Si encontramos un ID de categor√≠a, buscar en las categor√≠as
            if (categoriaId) {
                const categoria = categoriasData.find(cat => {
                    const catId = cat.id_categoria || cat.id;
                    return catId == categoriaId;
                });
                
                if (categoria) {
                    return categoria.nombre_categoria;
                }
            }
            
            // Si no encontramos categor√≠a de ninguna forma
            return 'Categor√≠a no asignada';
        }

        // Funci√≥n para obtener nombre de usuario por ID - VERSI√ìN MEJORADA
        function getNombreUsuario(publicidad) {
            // PRIMERO: Si viene el nombre de usuario directamente en la publicidad
            if (publicidad.usuario_nombre) {
                return publicidad.usuario_nombre;
            }
            
            // SEGUNDO: Buscar el ID de usuario en diferentes campos posibles
            let usuarioId = null;
            
            if (publicidad.id_usuario_id !== undefined && publicidad.id_usuario_id !== null) {
                usuarioId = publicidad.id_usuario_id;
            } else if (publicidad.id_usuario !== undefined && publicidad.id_usuario !== null) {
                usuarioId = publicidad.id_usuario;
            } else if (publicidad.usuario_id !== undefined && publicidad.usuario_id !== null) {
                usuarioId = publicidad.usuario_id;
            }
            
            if (!usuarioId) {
                return 'Usuario desconocido';
            }
            
            // Buscar en los usuarios cargados
            const usuario = usuariosData[usuarioId];
            if (usuario) {
                const nombre = usuario.nombre_completo || usuario.correo_electronico || `Usuario ${usuarioId}`;
                return nombre;
            } else {
                return `Usuario ${usuarioId}`;
            }
        }

        // Funci√≥n para calcular promedio de calificaciones
        function calcularPromedioCalificaciones(publicidadId, tipo) {
            const calificaciones = tipo === 'empresa' 
                ? calificacionesEmpresasData[publicidadId] || []
                : calificacionesData[publicidadId] || [];
                
            if (calificaciones.length === 0) return 0;
            
            const suma = calificaciones.reduce((total, cal) => total + cal.rating, 0);
            return (suma / calificaciones.length).toFixed(1);
        }

        // Renderizar categor√≠as en el sidebar
        function renderCategorias() {
            const container = document.getElementById('categoriesList');
            
            if (!categoriasData || categoriasData.length === 0) {
                container.innerHTML = '<div class="text-muted">No hay categor√≠as disponibles</div>';
                return;
            }

            let categoriasHTML = '';
            const categoriasVisibles = categoriasData.slice(0, 5);
            const categoriasOcultas = categoriasData.slice(5);

            // Categor√≠a "Todas" (seleccionada por defecto)
            categoriasHTML += `
                <a href="#" class="list-group-item list-group-item-action border-0 category-active category-filter" 
                   onclick="showAllCategories()" data-categoria-id="all">
                    üìÇ Todas las categor√≠as
                </a>
            `;

            // Categor√≠as visibles
            categoriasVisibles.forEach(categoria => {
                const categoriaId = categoria.id_categoria || categoria.id;
                categoriasHTML += `
                    <a href="#" class="list-group-item list-group-item-action border-0 category-filter" 
                       onclick="filterByCategory(${categoriaId})" data-categoria-id="${categoriaId}">
                        ${getCategoryIcon(categoria.nombre_categoria)} ${categoria.nombre_categoria}
                    </a>
                `;
            });

            // Categor√≠as ocultas
            if (categoriasOcultas.length > 0) {
                categoriasHTML += `
                    <div class="more-categories" id="moreCategories" style="display: none;">
                        ${categoriasOcultas.map(categoria => {
                            const categoriaId = categoria.id_categoria || categoria.id;
                            return `
                                <a href="#" class="list-group-item list-group-item-action border-0 category-filter" 
                                   onclick="filterByCategory(${categoriaId})" data-categoria-id="${categoriaId}">
                                    ${getCategoryIcon(categoria.nombre_categoria)} ${categoria.nombre_categoria}
                                </a>
                            `;
                        }).join('')}
                    </div>
                    <button class="show-more-btn mt-2" onclick="toggleMoreCategories()">
                        üìÇ Ver m√°s categor√≠as
                    </button>
                `;
            }

            container.innerHTML = categoriasHTML;
        }

        // Filtrar publicidades por categor√≠a
        function filterByCategory(categoriaId) {
            if (!requireLogin()) return;
            
            console.log(`üîç Filtrando por categor√≠a ID: ${categoriaId}`);
            
            // Encontrar la categor√≠a seleccionada
            const categoria = categoriasData.find(cat => {
                const catId = cat.id_categoria || cat.id;
                return catId == categoriaId;
            });
            
            if (!categoria) {
                console.log('‚ùå Categor√≠a no encontrada');
                return;
            }
            
            categoriaSeleccionada = categoria;
            
            // Actualizar UI de categor√≠as
            updateCategoryUI(categoriaId);
            
            // Filtrar publicidades por categor√≠a
            const publicidadesFiltradas = publicidadesData.filter(publicidad => {
                const categoriaPublicidad = getNombreCategoria(publicidad);
                const categoriaNombre = categoria.nombre_categoria;
                
                return categoriaPublicidad === categoriaNombre;
            });
            
            console.log(`‚úÖ Encontradas ${publicidadesFiltradas.length} publicidades para la categor√≠a "${categoria.nombre_categoria}"`);
            
            // Separar en empresas y talentos
            const { empresas, talentos } = separarEmpresasYTalentos(publicidadesFiltradas);
            
            // Renderizar contenido filtrado
            renderFilteredContent(empresas, talentos, categoria);
        }

        // Mostrar todas las categor√≠as (sin filtro)
        function showAllCategories() {
            if (!requireLogin()) return;
            
            console.log('üìÇ Mostrando todas las categor√≠as');
            
            categoriaSeleccionada = null;
            
            // Actualizar UI de categor√≠as
            updateCategoryUI('all');
            
            // Renderizar contenido completo
            renderHomeContent();
        }

        // Actualizar la UI de categor√≠as
        function updateCategoryUI(categoriaIdSeleccionada) {
            // Remover clase active de todas las categor√≠as
            document.querySelectorAll('.category-filter').forEach(item => {
                item.classList.remove('category-active');
            });
            
            // Agregar clase active a la categor√≠a seleccionada
            const categoriaSeleccionadaElement = document.querySelector(`[data-categoria-id="${categoriaIdSeleccionada}"]`);
            if (categoriaSeleccionadaElement) {
                categoriaSeleccionadaElement.classList.add('category-active');
            }
            
            // Mostrar/ocultar elementos de UI
            if (categoriaIdSeleccionada === 'all') {
                document.getElementById('backToAllContainer').style.display = 'none';
                document.getElementById('categoryTitleContainer').style.display = 'none';
                document.getElementById('categoryFilterText').style.display = 'none';
            } else {
                document.getElementById('backToAllContainer').style.display = 'block';
                document.getElementById('categoryTitleContainer').style.display = 'block';
                document.getElementById('categoryFilterText').style.display = 'inline';
                document.getElementById('categoryTitle').textContent = `${getCategoryIcon(categoriaSeleccionada.nombre_categoria)} ${categoriaSeleccionada.nombre_categoria}`;
                document.getElementById('categoryName').textContent = categoriaSeleccionada.nombre_categoria;
            }
        }

        // Renderizar contenido filtrado
        function renderFilteredContent(empresas, talentos, categoria) {
            // Actualizar contador
            updateResultsCounter(empresas, talentos, categoria);
            
            // Mostrar empresas/servicios filtrados
            renderEmpresasFiltradas(empresas, categoria);
            
            // Mostrar talentos filtrados
            renderTalentosFiltrados(talentos, categoria);
        }

        // Actualizar contador de resultados
        function updateResultsCounter(empresas, talentos, categoria) {
            const total = empresas.length + talentos.length;
            
            document.getElementById('totalResults').textContent = total;
            document.getElementById('empresasCount').textContent = empresas.length;
            document.getElementById('talentosCount').textContent = talentos.length;
        }

        // Renderizar empresas/servicios filtrados
        function renderEmpresasFiltradas(empresas, categoria) {
            const container = document.getElementById('empresasContainer');
            
            if (empresas.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="no-results">
                            <h5>üè¢ No hay empresas en esta categor√≠a</h5>
                            <p class="text-muted">No se encontraron empresas de "${categoria.nombre_categoria}" disponibles.</p>
                        </div>
                    </div>
                `;
                return;
            }

            let empresasHTML = '';
            
            empresas.forEach(publicidad => {
                const categoriaNombre = getNombreCategoria(publicidad);
                const nombreUsuario = getNombreUsuario(publicidad);
                const promedio = calcularPromedioCalificaciones(publicidad.id_publicidad, 'empresa');
                
                empresasHTML += `
                    <div class="col-md-6 mb-3">
                        <div class="card empresa-card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="card-title mb-0">${publicidad.titulo_publicidad}</h6>
                                <span class="badge badge-empresa">Empresa</span>
                            </div>
                            <div class="card-body">
                                <p class="card-text text-muted text-truncate-3">
                                    ${publicidad.descripcion_detallada}
                                </p>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <span class="badge bg-success">${categoriaNombre}</span>
                                    ${promedio > 0 ? `
                                        <div class="average-rating">
                                            <span class="text-warning">‚≠ê ${promedio}</span>
                                            <small class="text-muted">(${calificacionesEmpresasData[publicidad.id_publicidad]?.length || 0})</small>
                                        </div>
                                    ` : '<small class="text-muted">‚≠ê Sin calificaciones</small>'}
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <small class="text-muted">Publicado por: ${nombreUsuario}</small>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <small class="text-muted">${formatDate(publicidad.fecha_publicacion)}</small>
                                </div>
                            </div>
                            <div class="card-footer bg-white border-0">
                                <button class="btn btn-outline-secondary btn-sm" onclick="showEmpresaDetails(${publicidad.id_publicidad})">
                                    M√°s Informaci√≥n
                                </button>
                                <button class="btn btn-rating btn-sm" onclick="showEmpresaRatingModal(${publicidad.id_publicidad})">
                                    ‚≠ê Calificar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = empresasHTML;
        }

        // Renderizar talentos humanos filtrados
        function renderTalentosFiltrados(talentos, categoria) {
            const container = document.getElementById('talentosContainer');
            
            if (talentos.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="no-results">
                            <h5>üë• No hay talentos en esta categor√≠a</h5>
                            <p class="text-muted">No se encontraron talentos de "${categoria.nombre_categoria}" disponibles.</p>
                        </div>
                    </div>
                `;
                return;
            }

            let talentosHTML = '';
            
            talentos.forEach(publicidad => {
                const categoriaNombre = getNombreCategoria(publicidad);
                const nombreUsuario = getNombreUsuario(publicidad);
                const promedio = calcularPromedioCalificaciones(publicidad.id_publicidad, 'talento');
                
                talentosHTML += `
                    <div class="col-md-4 mb-3">
                        <div class="card talent-card h-100">
                            <div class="card-body">
                                <h6 class="card-title">${publicidad.titulo_publicidad}</h6>
                                <p class="card-text small text-muted text-truncate-3">
                                    ${publicidad.descripcion_detallada}
                                </p>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="badge bg-info text-dark">${categoriaNombre}</span>
                                    ${promedio > 0 ? `
                                        <div class="average-rating">
                                            <span class="text-warning">‚≠ê ${promedio}</span>
                                            <small class="text-muted">(${calificacionesData[publicidad.id_publicidad]?.length || 0})</small>
                                        </div>
                                    ` : '<small class="text-muted">‚≠ê Sin calificaciones</small>'}
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted"><strong>Publicado por:</strong> ${nombreUsuario}</small>
                                </div>
                            </div>
                            <div class="card-footer bg-white border-0">
                                <button class="btn btn-outline-secondary btn-sm" onclick="showTalentoDetails(${publicidad.id_publicidad})">
                                    M√°s Informaci√≥n
                                </button>
                                <button class="btn btn-rating btn-sm" onclick="showRatingModal(${publicidad.id_publicidad})">
                                    ‚≠ê Calificar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = talentosHTML;
        }

        // Renderizar contenido del home (todas las categor√≠as)
        function renderHomeContent() {
            // Separar en empresas y talentos
            const { empresas, talentos } = separarEmpresasYTalentos(publicidadesData);
            
            // Actualizar contador
            updateResultsCounter(empresas, talentos, null);
            
            renderEmpresas(empresas);
            renderTalentos(talentos);
        }

        // Renderizar empresas/servicios (todas las categor√≠as)
        function renderEmpresas(empresas) {
            const container = document.getElementById('empresasContainer');
            
            if (empresas.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center">
                        <p class="text-muted">No hay empresas disponibles en este momento.</p>
                    </div>
                `;
                return;
            }

            let empresasHTML = '';
            
            empresas.forEach(publicidad => {
                const categoriaNombre = getNombreCategoria(publicidad);
                const nombreUsuario = getNombreUsuario(publicidad);
                const promedio = calcularPromedioCalificaciones(publicidad.id_publicidad, 'empresa');
                
                empresasHTML += `
                    <div class="col-md-6 mb-3">
                        <div class="card empresa-card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="card-title mb-0">${publicidad.titulo_publicidad}</h6>
                                <span class="badge badge-empresa">Empresa</span>
                            </div>
                            <div class="card-body">
                                <p class="card-text text-muted text-truncate-3">
                                    ${publicidad.descripcion_detallada}
                                </p>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <span class="badge bg-success">${categoriaNombre}</span>
                                    ${promedio > 0 ? `
                                        <div class="average-rating">
                                            <span class="text-warning">‚≠ê ${promedio}</span>
                                            <small class="text-muted">(${calificacionesEmpresasData[publicidad.id_publicidad]?.length || 0})</small>
                                        </div>
                                    ` : '<small class="text-muted">‚≠ê Sin calificaciones</small>'}
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <small class="text-muted">Publicado por: ${nombreUsuario}</small>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <small class="text-muted">${formatDate(publicidad.fecha_publicacion)}</small>
                                </div>
                            </div>
                            <div class="card-footer bg-white border-0">
                                <button class="btn btn-outline-secondary btn-sm" onclick="showEmpresaDetails(${publicidad.id_publicidad})">
                                    M√°s Informaci√≥n
                                </button>
                                <button class="btn btn-rating btn-sm" onclick="showEmpresaRatingModal(${publicidad.id_publicidad})">
                                    ‚≠ê Calificar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = empresasHTML;
        }

        // Renderizar talentos humanos (todas las categor√≠as)
        function renderTalentos(talentos) {
            const container = document.getElementById('talentosContainer');
            
            if (talentos.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center">
                        <p class="text-muted">No hay talentos disponibles en este momento.</p>
                    </div>
                `;
                return;
            }

            let talentosHTML = '';
            
            talentos.forEach(publicidad => {
                const categoriaNombre = getNombreCategoria(publicidad);
                const nombreUsuario = getNombreUsuario(publicidad);
                const promedio = calcularPromedioCalificaciones(publicidad.id_publicidad, 'talento');
                
                talentosHTML += `
                    <div class="col-md-4 mb-3">
                        <div class="card talent-card h-100">
                            <div class="card-body">
                                <h6 class="card-title">${publicidad.titulo_publicidad}</h6>
                                <p class="card-text small text-muted text-truncate-3">
                                    ${publicidad.descripcion_detallada}
                                </p>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="badge bg-info text-dark">${categoriaNombre}</span>
                                    ${promedio > 0 ? `
                                        <div class="average-rating">
                                            <span class="text-warning">‚≠ê ${promedio}</span>
                                            <small class="text-muted">(${calificacionesData[publicidad.id_publicidad]?.length || 0})</small>
                                        </div>
                                    ` : '<small class="text-muted">‚≠ê Sin calificaciones</small>'}
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted"><strong>Publicado por:</strong> ${nombreUsuario}</small>
                                </div>
                            </div>
                            <div class="card-footer bg-white border-0">
                                <button class="btn btn-outline-secondary btn-sm" onclick="showTalentoDetails(${publicidad.id_publicidad})">
                                    M√°s Informaci√≥n
                                </button>
                                <button class="btn btn-rating btn-sm" onclick="showRatingModal(${publicidad.id_publicidad})">
                                    ‚≠ê Calificar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = talentosHTML;
        }

        // Funci√≥n para obtener icono seg√∫n categor√≠a
        function getCategoryIcon(categoriaNombre) {
            const iconMap = {
                'electricidad': '‚ö°',
                'construcci√≥n': 'üß±',
                'plomer√≠a': 'üîß',
                'carpinter√≠a': 'üõ†Ô∏è',
                'refrigeraci√≥n': '‚ùÑÔ∏è',
                'mec√°nica': 'üöó',
                'turismo': 'üß≥',
                'limpieza': 'üè°',
                'reposter√≠a': 'üéÇ',
                'educaci√≥n': 'üéì',
                'cuidado': 'üë∂',
                'belleza': 'üíá',
                'programaci√≥n': 'üíª',
                'dise√±o': 'üé®',
                'general': 'üîÆ'
            };

            for (const [key, icon] of Object.entries(iconMap)) {
                if (categoriaNombre.toLowerCase().includes(key)) {
                    return icon;
                }
            }
            return 'üîÆ';
        }

        // Funci√≥n para formatear fecha
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                return date.toLocaleDateString('es-ES', options);
            } catch (error) {
                return 'Fecha no disponible';
            }
        }

        // VERIFICACI√ìN DE AUTENTICACI√ìN MEJORADA
        async function checkAuthentication() {
            const token = localStorage.getItem('access_token');
            
            if (!token) {
                showPublicUI();
                return;
            }

            try {
                // Usamos Promise.race para agregar un timeout
                const response = await Promise.race([
                    fetch(`${BACKEND_URL}/auth/user-profile/`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout')), 3000)
                    )
                ]);

                if (response.ok) {
                    showAuthenticatedUI();
                } else {
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    localStorage.removeItem('user_data');
                    showPublicUI();
                }
                
            } catch (error) {
                console.error('Error verificando autenticaci√≥n:', error);
                // En caso de error, mostramos la UI p√∫blica
                showPublicUI();
            }
        }

        function showAuthenticatedUI() {
            const userData = localStorage.getItem('user_data');
            let userName = 'Usuario';
            
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    userName = user.nombre_completo || user.correo_electronico || 'Usuario';
                } catch (e) {
                    console.error('Error parsing user data:', e);
                }
            }
            
            document.getElementById('userWelcome').textContent = `üëã Bienvenido, ${userName}`;
            document.getElementById('authButtons').style.display = 'none';
            document.getElementById('userMenu').style.display = 'flex';
            document.querySelectorAll('.login-badge').forEach(badge => {
                badge.style.display = 'none';
            });
            document.getElementById('publicContent').style.display = 'none';
        }

        function showPublicUI() {
            document.getElementById('userWelcome').textContent = 'üëã Bienvenido a WORKLY';
            document.getElementById('authButtons').style.display = 'block';
            document.getElementById('userMenu').style.display = 'none';
            document.querySelectorAll('.login-badge').forEach(badge => {
                badge.style.display = 'block';
            });
            document.getElementById('publicContent').style.display = 'flex';
        }

        function toggleMoreCategories() {
            const moreCategories = document.getElementById('moreCategories');
            const button = document.querySelector('.show-more-btn');
            
            if (moreCategories.style.display === 'none' || moreCategories.style.display === '') {
                moreCategories.style.display = 'block';
                button.textContent = 'üìÇ Ver menos categor√≠as';
            } else {
                moreCategories.style.display = 'none';
                button.textContent = 'üìÇ Ver m√°s categor√≠as';
            }
        }

        function requireLogin() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                loginRequiredModal.show();
                return false;
            }
            return true;
        }

        // Funci√≥n para mostrar detalles de empresa/servicio
        function showEmpresaDetails(publicidadId) {
            if (!requireLogin()) return;
            
            const publicidad = publicidadesData.find(p => p.id_publicidad === publicidadId);
            if (!publicidad) {
                showError('No se encontr√≥ la informaci√≥n del servicio');
                return;
            }
            
            const categoriaNombre = getNombreCategoria(publicidad);
            const nombreUsuario = getNombreUsuario(publicidad);
            const calificaciones = calificacionesEmpresasData[publicidadId] || [];
            const promedio = calcularPromedioCalificaciones(publicidadId, 'empresa');
            
            // Generar contenido del modal
            const modalContent = `
                <div class="info-item">
                    <div class="info-label">Nombre del servicio</div>
                    <div class="info-value">${publicidad.titulo_publicidad}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Categor√≠a</div>
                    <div class="info-value">${categoriaNombre}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Tipo de Membres√≠a</div>
                    <div class="info-value">B√°sica</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Contacto</div>
                    <div class="info-value">${publicidad.telefono_contacto || '+573001234567'}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Ubicaci√≥n</div>
                    <div class="info-value">${publicidad.ubicacion || 'Ciudad o zona donde opera'}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">A√±os de experiencia</div>
                    <div class="info-value">${publicidad.experiencia || 'A√±os de experiencia en el campo'}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Descripci√≥n</div>
                    <div class="info-value">${publicidad.descripcion_detallada || 'Servicio profesional de calidad'}</div>
                </div>
                
                ${promedio > 0 ? `
                <div class="info-item">
                    <div class="info-label">Calificaci√≥n promedio</div>
                    <div class="info-value">
                        <div class="average-rating">
                            <span class="text-warning" style="font-size: 1.2rem;">‚≠ê ${promedio}</span>
                            <small class="text-muted">(${calificaciones.length} calificaciones)</small>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                ${calificaciones.length > 0 ? `
                <div class="info-item">
                    <div class="info-label">Calificaciones anteriores</div>
                    <div id="calificacionesList">
                        ${calificaciones.map(calificacion => `
                            <div class="rating-item">
                                <div class="rating-user">${calificacion.usuario}</div>
                                <div class="rating-stars small">
                                    ${'‚òÖ'.repeat(calificacion.rating)}${'‚òÜ'.repeat(5 - calificacion.rating)}
                                </div>
                                <div class="rating-date">${calificacion.fecha}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            `;
            
            // Actualizar el modal
            document.getElementById('empresaDetailsContent').innerHTML = modalContent;
            document.getElementById('empresaDetailsModalLabel').textContent = publicidad.titulo_publicidad;
            
            // Mostrar el modal
            empresaDetailsModal.show();
        }

        // Funci√≥n para mostrar detalles de talento
        function showTalentoDetails(publicidadId) {
            if (!requireLogin()) return;
            
            const publicidad = publicidadesData.find(p => p.id_publicidad === publicidadId);
            if (!publicidad) {
                showError('No se encontr√≥ la informaci√≥n del talento');
                return;
            }
            
            const categoriaNombre = getNombreCategoria(publicidad);
            const nombreUsuario = getNombreUsuario(publicidad);
            const calificaciones = calificacionesData[publicidadId] || [];
            const promedio = calcularPromedioCalificaciones(publicidadId, 'talento');
            
            // Generar contenido del modal
            const modalContent = `
                <div class="info-item">
                    <div class="info-label">Nombre del talento</div>
                    <div class="info-value">${publicidad.titulo_publicidad}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Categor√≠a</div>
                    <div class="info-value">${categoriaNombre}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Tipo de Membres√≠a</div>
                    <div class="info-value">B√°sica</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Contacto</div>
                    <div class="info-value">${publicidad.telefono_contacto || '+573001234567'}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Ubicaci√≥n</div>
                    <div class="info-value">${publicidad.ubicacion || 'Ciudad o zona donde trabajas'}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">A√±os de experiencia</div>
                    <div class="info-value">${publicidad.experiencia || 'A√±os de experiencia en el campo'}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Descripci√≥n</div>
                    <div class="info-value">${publicidad.descripcion_detallada || 'ingeniero en software promedio'}</div>
                </div>
                
                ${promedio > 0 ? `
                <div class="info-item">
                    <div class="info-label">Calificaci√≥n promedio</div>
                    <div class="info-value">
                        <div class="average-rating">
                            <span class="text-warning" style="font-size: 1.2rem;">‚≠ê ${promedio}</span>
                            <small class="text-muted">(${calificaciones.length} calificaciones)</small>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                ${calificaciones.length > 0 ? `
                <div class="info-item">
                    <div class="info-label">Calificaciones anteriores</div>
                    <div id="calificacionesList">
                        ${calificaciones.map(calificacion => `
                            <div class="rating-item">
                                <div class="rating-user">${calificacion.usuario}</div>
                                <div class="rating-stars small">
                                    ${'‚òÖ'.repeat(calificacion.rating)}${'‚òÜ'.repeat(5 - calificacion.rating)}
                                </div>
                                <div class="rating-date">${calificacion.fecha}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            `;
            
            // Actualizar el modal
            document.getElementById('talentoDetailsContent').innerHTML = modalContent;
            document.getElementById('talentoDetailsModalLabel').textContent = publicidad.titulo_publicidad;
            
            // Mostrar el modal
            talentoDetailsModal.show();
        }

        // Funci√≥n para mostrar modal de calificaci√≥n de empresa
        function showEmpresaRatingModal(publicidadId) {
            if (!requireLogin()) return;
            
            const publicidad = publicidadesData.find(p => p.id_publicidad === publicidadId);
            if (!publicidad) {
                showError('No se encontr√≥ la informaci√≥n de la empresa');
                return;
            }
            
            currentPublicidadId = publicidadId;
            currentRating = 0;
            currentRatingType = 'empresa';
            
            // Generar contenido del modal
            const modalContent = `
                <div class="text-center">
                    <h6>Calificar a: ${publicidad.titulo_publicidad}</h6>
                    <p class="text-muted">Selecciona de 1 a 5 estrellas</p>
                    
                    <div class="rating-stars mb-3" id="ratingStars">
                        <span class="star" data-rating="1">‚òÜ</span>
                        <span class="star" data-rating="2">‚òÜ</span>
                        <span class="star" data-rating="3">‚òÜ</span>
                        <span class="star" data-rating="4">‚òÜ</span>
                        <span class="star" data-rating="5">‚òÜ</span>
                    </div>
                    
                    <div id="ratingValue" class="text-muted">Selecciona una calificaci√≥n</div>
                </div>
            `;
            
            // Actualizar el modal
            document.getElementById('ratingEmpresaContent').innerHTML = modalContent;
            document.getElementById('ratingEmpresaModalLabel').textContent = `Calificar: ${publicidad.titulo_publicidad}`;
            
            // Configurar el sistema de calificaci√≥n
            setupRatingSystem();
            
            // Configurar el bot√≥n de confirmaci√≥n
            document.getElementById('confirmEmpresaRatingBtn').onclick = function() {
                if (currentRating === 0) {
                    showError('Por favor selecciona una calificaci√≥n');
                    return;
                }
                guardarCalificacion();
            };
            
            // Mostrar el modal
            ratingEmpresaModal.show();
        }

        // Funci√≥n para mostrar modal de calificaci√≥n de talento
        function showRatingModal(publicidadId) {
            if (!requireLogin()) return;
            
            const publicidad = publicidadesData.find(p => p.id_publicidad === publicidadId);
            if (!publicidad) {
                showError('No se encontr√≥ la informaci√≥n del talento');
                return;
            }
            
            currentPublicidadId = publicidadId;
            currentRating = 0;
            currentRatingType = 'talento';
            
            // Generar contenido del modal
            const modalContent = `
                <div class="text-center">
                    <h6>Calificar a: ${publicidad.titulo_publicidad}</h6>
                    <p class="text-muted">Selecciona de 1 a 5 estrellas</p>
                    
                    <div class="rating-stars mb-3" id="ratingStars">
                        <span class="star" data-rating="1">‚òÜ</span>
                        <span class="star" data-rating="2">‚òÜ</span>
                        <span class="star" data-rating="3">‚òÜ</span>
                        <span class="star" data-rating="4">‚òÜ</span>
                        <span class="star" data-rating="5">‚òÜ</span>
                    </div>
                    
                    <div id="ratingValue" class="text-muted">Selecciona una calificaci√≥n</div>
                </div>
            `;
            
            // Actualizar el modal
            document.getElementById('ratingContent').innerHTML = modalContent;
            document.getElementById('ratingModalLabel').textContent = `Calificar: ${publicidad.titulo_publicidad}`;
            
            // Configurar el sistema de calificaci√≥n
            setupRatingSystem();
            
            // Configurar el bot√≥n de confirmaci√≥n
            document.getElementById('confirmRatingBtn').onclick = function() {
                if (currentRating === 0) {
                    showError('Por favor selecciona una calificaci√≥n');
                    return;
                }
                guardarCalificacion();
            };
            
            // Mostrar el modal
            ratingModal.show();
        }

        // Configurar el sistema de calificaci√≥n con estrellas
        function setupRatingSystem() {
            const stars = document.querySelectorAll('.star');
            const ratingValue = document.getElementById('ratingValue');
            
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    currentRating = rating;
                    
                    // Actualizar estrellas
                    stars.forEach((s, index) => {
                        if (index < rating) {
                            s.textContent = '‚òÖ';
                            s.style.color = '#ffc107';
                        } else {
                            s.textContent = '‚òÜ';
                            s.style.color = '#ffc107';
                        }
                    });
                    
                    // Actualizar texto
                    ratingValue.textContent = `Has seleccionado ${rating} estrella${rating > 1 ? 's' : ''}`;
                    ratingValue.style.color = '#495057';
                });
                
                // Efecto hover
                star.addEventListener('mouseover', function() {
                    const hoverRating = parseInt(this.getAttribute('data-rating'));
                    
                    stars.forEach((s, index) => {
                        if (index < hoverRating) {
                            s.style.color = '#ffc107';
                        } else {
                            s.style.color = '#e0e0e0';
                        }
                    });
                });
                
                star.addEventListener('mouseout', function() {
                    stars.forEach((s, index) => {
                        if (index < currentRating) {
                            s.style.color = '#ffc107';
                        } else {
                            s.style.color = '#ffc107';
                        }
                    });
                });
            });
        }

        // Funci√≥n para guardar calificaci√≥n
        function guardarCalificacion() {
            // Obtener informaci√≥n del usuario actual
            const userData = localStorage.getItem('user_data');
            let userName = 'Usuario An√≥nimo';
            
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    userName = user.nombre_completo || user.correo_electronico || 'Usuario';
                } catch (e) {
                    console.error('Error parsing user data:', e);
                }
            }
            
            // Crear objeto de calificaci√≥n
            const nuevaCalificacion = {
                rating: currentRating,
                usuario: userName,
                fecha: new Date().toLocaleDateString('es-ES')
            };
            
            // Determinar qu√© conjunto de datos usar
            const calificacionesTarget = currentRatingType === 'empresa' 
                ? calificacionesEmpresasData 
                : calificacionesData;
            
            // Inicializar array si no existe
            if (!calificacionesTarget[currentPublicidadId]) {
                calificacionesTarget[currentPublicidadId] = [];
            }
            
            // Verificar si el usuario ya calific√≥
            const calificacionExistenteIndex = calificacionesTarget[currentPublicidadId].findIndex(
                cal => cal.usuario === userName
            );
            
            if (calificacionExistenteIndex !== -1) {
                // Actualizar calificaci√≥n existente
                calificacionesTarget[currentPublicidadId][calificacionExistenteIndex] = nuevaCalificacion;
            } else {
                // Agregar nueva calificaci√≥n
                calificacionesTarget[currentPublicidadId].push(nuevaCalificacion);
            }
            
            // Guardar en localStorage (en producci√≥n ser√≠a en la base de datos)
            localStorage.setItem('workly_calificaciones', JSON.stringify(calificacionesData));
            localStorage.setItem('workly_calificaciones_empresas', JSON.stringify(calificacionesEmpresasData));
            
            console.log(`‚úÖ Calificaci√≥n guardada: ${currentRating} estrellas por ${userName} para ${currentRatingType} ${currentPublicidadId}`);
            
            // Cerrar modal y mostrar mensaje de √©xito
            if (currentRatingType === 'empresa') {
                ratingEmpresaModal.hide();
            } else {
                ratingModal.hide();
            }
            
            showSuccess('¬°Calificaci√≥n guardada exitosamente!');
            
            // Actualizar la vista
            renderHomeContent();
        }

        function showSuccess(message) {
            // Crear alerta temporal
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Remover despu√©s de 3 segundos
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }

        function showCategoryPage(categoriaId) {
            if (requireLogin()) {
                filterByCategory(categoriaId);
            }
        }

        function showMainPage() {
            document.getElementById('mainPage').style.display = 'block';
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_data');
            window.location.href = "/logout/";
        }

        function showError(message) {
            alert(`‚ùå Error: ${message}`);
        }
    </script>
</body>
</html>