<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WORKLY - Publicar Talento Humano</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        
        /* Bot√≥n de volver en esquina superior izquierda */
        .back-button-container {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
        }
        
        .back-button {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            color: #2c3e50;
            padding: 12px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .back-button:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        
        /* Contenedor principal expandido */
        .main-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            width: 100%;
        }
        
        .publish-container {
            width: 95%;
            max-width: 1200px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 80vh;
        }
        
        .publish-header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
        }
        
        .publish-header h1 {
            font-size: 32px;
            font-weight: 700;
            margin: 0 0 10px 0;
        }
        
        .publish-header p {
            font-size: 18px;
            opacity: 0.9;
            margin: 0;
        }
        
        .content-wrapper {
            display: flex;
            flex: 1;
        }
        
        .form-section {
            flex: 1;
            padding: 40px;
        }
        
        .info-section {
            flex: 0 0 400px;
            background: #f8f9fa;
            padding: 40px;
            border-left: 1px solid #eaeaea;
        }
        
        .form-group {
            margin-bottom: 30px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .form-control {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #eaeaea;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .form-control:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            background: white;
        }
        
        .form-textarea {
            min-height: 150px;
            resize: vertical;
        }
        
        .divider {
            height: 2px;
            background: linear-gradient(to right, transparent, #eaeaea, transparent);
            margin: 35px 0;
        }
        
        .publish-btn {
            display: block;
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .publish-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .info-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #3498db;
        }
        
        .info-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-card p {
            color: #5a6c7d;
            line-height: 1.6;
            margin: 0;
        }
        
        .footer {
            background: #2c3e50;
            color: white;
            text-align: center;
            padding: 25px;
            margin-top: auto;
        }
        
        .footer p {
            margin: 0;
            color: #bdc3c7;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        /* Estilos para el tipo de usuario detectado */
        .user-type-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }
        
        @media (max-width: 992px) {
            .content-wrapper {
                flex-direction: column;
            }
            
            .info-section {
                flex: none;
                border-left: none;
                border-top: 1px solid #eaeaea;
            }
            
            .publish-header {
                padding: 30px 20px;
            }
            
            .form-section, .info-section {
                padding: 30px;
            }
        }
        
        @media (max-width: 768px) {
            .publish-container {
                width: 100%;
                border-radius: 0;
                min-height: 100vh;
            }
            
            .main-container {
                padding: 0;
            }
            
            .back-button-container {
                top: 15px;
                left: 15px;
            }
            
            .back-button {
                padding: 10px 15px;
                font-size: 14px;
            }

            .user-type-badge {
                top: 15px;
                right: 15px;
                font-size: 12px;
                padding: 6px 12px;
            }
        }
        
        @media (max-width: 480px) {
            .form-section, .info-section {
                padding: 20px;
            }
            
            .publish-header {
                padding: 25px 15px;
            }
            
            .publish-header h1 {
                font-size: 26px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Cargando informaci√≥n...</span>
            </div>
            <h5>Cargando informaci√≥n del usuario...</h5>
            <p class="text-muted">Por favor espera mientras obtenemos tus datos</p>
        </div>
    </div>

    <!-- Bot√≥n de volver en esquina superior izquierda -->
    <div class="back-button-container">
        <button class="back-button" onclick="goBack()">
            <span>‚Üê</span> Volver
        </button>
    </div>

    <!-- Contenedor principal -->
    <div class="main-container">
        <div class="publish-container">
            <div class="publish-header">
                <h1 id="pageTitle">Publicar talento humano</h1>
                <p id="pageSubtitle">Comparte tu talento con nuestra comunidad WORKLY</p>
                <!-- Badge para mostrar el tipo de usuario detectado -->
                <div id="userTypeBadge" class="user-type-badge" style="display: none;"></div>
            </div>
            
            <div class="content-wrapper">
                <div class="form-section">
                    <!-- Formulario para Talento Humano -->
                    <form id="talentForm">
                        <!-- Campo oculto para el ID del usuario -->
                        <input type="hidden" id="userId" value="">
                        <!-- Campo oculto para el tipo de usuario -->
                        <input type="hidden" id="userType" value="">
                        
                        <div class="form-group">
                            <label for="nombre" class="form-label">Nombre del talento</label>
                            <input type="text" id="nombre" class="form-control" placeholder="Ingresa tu Nombre completo">
                        </div>
                        
                        <div class="form-group">
                            <label for="categoria" class="form-label">Categor√≠a</label>
                            <select id="categoria" class="form-control">
                                <option value="" disabled selected>Selecciona una categor√≠a</option>
                                <option value="1">‚ö° Electricidad</option>
                                <option value="2">üß± Construcci√≥n</option>
                                <option value="3">üîß Plomer√≠a</option>
                                <option value="4">üõ†Ô∏è Carpinter√≠a</option>
                                <option value="5">‚ùÑÔ∏è Refrigeraci√≥n / Aire Acondicionado</option>
                                <option value="6">üöó Mec√°nica automotriz</option>
                                <option value="7">üß≥ Turismo / Gu√≠as / Hoteler√≠a</option>
                                <option value="8">üè° Limpieza</option>
                                <option value="9">üéÇ Reposter√≠a</option>
                                <option value="10">üéì Tutor√≠as / Educaci√≥n</option>
                                <option value="11">üë∂ Cuidado infantil / Adultos mayores</option>
                                <option value="12">üíá Belleza</option>
                                <option value="13">üîÆ Otros</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="membresia" class="form-label">Tipo de Membres√≠a</label>
                            <select id="membresia" class="form-control">
                                <option value="basica">B√°sica</option>
                                <option value="premium">Premium</option>
                                <option value="empresa">Empresa</option>
                                <option value="gratuita">Gratuita</option>
                                <option value="estandar">Est√°ndar</option>
                                <option value="1">1 - B√°sica</option>
                                <option value="2">2 - Premium</option>
                                <option value="3">3 - Empresa</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="contacto" class="form-label">Contacto</label>
                            <input type="text" id="contacto" class="form-control" placeholder="Num. de contacto">
                        </div>
                        
                        <div class="form-group">
                            <label for="ubicacion" class="form-label">Ubicaci√≥n</label>
                            <input type="text" id="ubicacion" class="form-control" placeholder="Ciudad o zona donde trabajas">
                        </div>
                        
                        <div class="form-group">
                            <label for="experiencia" class="form-label">A√±os de experiencia</label>
                            <input type="number" id="experiencia" class="form-control" placeholder="A√±os de experiencia en el campo">
                        </div>
                        
                        <div class="form-group">
                            <label for="descripcion" class="form-label">Descripci√≥n</label>
                            <textarea id="descripcion" class="form-control form-textarea" placeholder="Describe tus habilidades, experiencia y servicios que ofreces..."></textarea>
                        </div>
                        
                        <div class="divider"></div>
                        
                        <button type="button" class="publish-btn" onclick="submitTalentForm()">Publicar Talento</button>
                    </form>
                </div>
                
                <div class="info-section">
                    <div class="info-card">
                        <h3>üí° Consejos para Publicar</h3>
                        <p>‚Ä¢ Completa todos los campos obligatorios</p>
                        <p>‚Ä¢ S√© espec√≠fico en tu descripci√≥n</p>
                        <p>‚Ä¢ Incluye informaci√≥n de contacto v√°lida</p>
                        <p>‚Ä¢ Selecciona la categor√≠a m√°s adecuada</p>
                    </div>
                    
                    <div class="info-card">
                        <h3>üöÄ Beneficios WORKLY</h3>
                        <p>‚Ä¢ Alcance a miles de clientes potenciales</p>
                        <p>‚Ä¢ Perfil profesional destacado</p>
                        <p>‚Ä¢ Sistema de rese√±as y calificaciones</p>
                        <p>‚Ä¢ Soporte y asistencia continua</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>üöÄ WORKLY - Tu plataforma de confianza para servicios profesionales</p>
        <p>&copy; 2024 WORKLY. Todos los derechos reservados.</p>
    </div>

    <script>
        const BACKEND_URL = 'http://127.0.0.1:8001';
        let userData = null;

        // Verificar autenticaci√≥n y cargar datos del usuario al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuthenticationAndLoadUserData();
        });

        // Verificar autenticaci√≥n y cargar datos del usuario
        async function checkAuthenticationAndLoadUserData() {
            const token = localStorage.getItem('access_token');
            
            if (!token) {
                redirectToLogin();
                return;
            }

            showLoading(true);

            try {
                // Obtener datos del perfil del usuario
                const response = await fetch(`${BACKEND_URL}/auth/user-profile/`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const responseData = await response.json();
                userData = responseData.data || responseData;
                
                console.log('üë§ Datos completos del usuario:', userData);
                
                // Guardar datos del usuario en localStorage para acceso posterior
                localStorage.setItem('user_data', JSON.stringify(userData));
                
                // Detectar y configurar el tipo de usuario
                await detectAndConfigureUserType(userData);
                
                // Autocompletar formulario con datos del usuario
                autocompleteFormWithUserData(userData);
                
            } catch (error) {
                console.error('Error cargando datos del usuario:', error);
                alert('Error al cargar los datos del usuario. Por favor, intenta nuevamente.');
            } finally {
                showLoading(false);
            }
        }

        // FUNCI√ìN NUEVA - Detectar y configurar el tipo de usuario
        async function detectAndConfigureUserType(userData) {
            console.log('üîç Detectando tipo de usuario...');
            
            // Buscar el tipo de usuario en diferentes propiedades posibles
            const userType = getUserType(userData);
            
            if (userType) {
                console.log(`‚úÖ Tipo de usuario detectado: ${userType}`);
                document.getElementById('userType').value = userType;
                
                // Actualizar la interfaz seg√∫n el tipo de usuario
                updateInterfaceForUserType(userType);
                
                // Mostrar badge con el tipo de usuario
                showUserTypeBadge(userType);
            } else {
                console.log('‚ùì Tipo de usuario no detectado, usando predeterminado: talento_humano');
                document.getElementById('userType').value = 'talento_humano';
                showUserTypeBadge('Talento Humano (predeterminado)');
            }
        }

        // FUNCI√ìN NUEVA - Obtener el tipo de usuario
        function getUserType(userData) {
            if (!userData) return null;

            // Buscar en diferentes propiedades posibles
            const possibleTypeFields = [
                'tipo_usuario', 'user_type', 'tipoUsuario', 'type', 'rol',
                'role', 'perfil', 'profile', 'tipo', 'userType'
            ];

            for (let field of possibleTypeFields) {
                if (userData[field] !== undefined && userData[field] !== null) {
                    console.log(`‚úÖ Tipo encontrado en campo: ${field} = ${userData[field]}`);
                    return userData[field].toString().toLowerCase();
                }
            }

            // Buscar en objetos anidados
            if (userData.data && typeof userData.data === 'object') {
                for (let field of possibleTypeFields) {
                    if (userData.data[field] !== undefined && userData.data[field] !== null) {
                        console.log(`‚úÖ Tipo encontrado en data.${field} = ${userData.data[field]}`);
                        return userData.data[field].toString().toLowerCase();
                    }
                }
            }

            // Buscar en propiedades relacionadas con empresa
            const empresaFields = ['empresa', 'company', 'es_empresa', 'is_company', 'tipo_empresa'];
            for (let field of empresaFields) {
                if (userData[field] !== undefined && userData[field] !== null) {
                    if (userData[field] === true || userData[field] === 'true' || userData[field] === 'empresa') {
                        console.log(`‚úÖ Empresa detectada en campo: ${field}`);
                        return 'empresa';
                    }
                }
            }

            console.log('‚ùå No se pudo detectar el tipo de usuario');
            return null;
        }

        // FUNCI√ìN NUEVA - Actualizar interfaz seg√∫n el tipo de usuario
        function updateInterfaceForUserType(userType) {
            const pageTitle = document.getElementById('pageTitle');
            const pageSubtitle = document.getElementById('pageSubtitle');
            const publishButton = document.querySelector('.publish-btn');

            if (userType === 'empresa' || userType === 'company') {
                pageTitle.textContent = 'Publicar oferta de empresa';
                pageSubtitle.textContent = 'Publica oportunidades laborales en tu empresa';
                publishButton.textContent = 'Publicar Oferta';
                
                // Actualizar placeholders para empresa
                document.getElementById('nombre').placeholder = 'Nombre de la empresa';
                document.getElementById('descripcion').placeholder = 'Describe la oferta laboral, requisitos y beneficios...';
                
            } else {
                // Por defecto, asumimos talento humano
                pageTitle.textContent = 'Publicar talento humano';
                pageSubtitle.textContent = 'Comparte tu talento con nuestra comunidad WORKLY';
                publishButton.textContent = 'Publicar Talento';
            }
        }

        // FUNCI√ìN NUEVA - Mostrar badge con el tipo de usuario
        function showUserTypeBadge(userType) {
            const badge = document.getElementById('userTypeBadge');
            
            let displayText = '';
            let backgroundColor = '';
            
            if (userType === 'empresa' || userType === 'company') {
                displayText = 'üè¢ Empresa';
                backgroundColor = '#e74c3c';
            } else if (userType === 'talento_humano' || userType === 'talento' || userType === 'personal') {
                displayText = 'üë§ Talento Humano';
                backgroundColor = '#3498db';
            } else {
                displayText = `üîç ${userType}`;
                backgroundColor = '#9b59b6';
            }
            
            badge.textContent = displayText;
            badge.style.backgroundColor = backgroundColor;
            badge.style.display = 'block';
        }

        // FUNCI√ìN MEJORADA - Extraer ID del usuario de m√∫ltiples formas posibles
        function getUserId(userData) {
            if (!userData) {
                console.error('‚ùå No hay datos de usuario disponibles');
                return null;
            }

            console.log('üîç Buscando ID en datos del usuario:', userData);

            // Buscar el ID en diferentes propiedades posibles
            const possibleIdFields = [
                'id_usuario', 'id', 'user_id', 'usuario_id', 'userId',
                'idUsuario', 'ID', 'Id'
            ];

            for (let field of possibleIdFields) {
                if (userData[field] !== undefined && userData[field] !== null) {
                    console.log(`‚úÖ ID encontrado en campo: ${field} = ${userData[field]}`);
                    return userData[field];
                }
            }

            // Si no se encuentra en las propiedades directas, buscar en objetos anidados
            if (userData.data && typeof userData.data === 'object') {
                for (let field of possibleIdFields) {
                    if (userData.data[field] !== undefined && userData.data[field] !== null) {
                        console.log(`‚úÖ ID encontrado en data.${field} = ${userData.data[field]}`);
                        return userData.data[field];
                    }
                }
            }

            console.error('‚ùå No se pudo encontrar el ID del usuario en ninguna propiedad conocida');
            console.log('üìã Propiedades disponibles:', Object.keys(userData));
            return null;
        }

        // Autocompletar formulario con datos del usuario
        function autocompleteFormWithUserData(user) {
            // Obtener y establecer ID del usuario
            const userId = getUserId(user);
            if (userId) {
                document.getElementById('userId').value = userId;
                console.log(`‚úÖ ID del usuario establecido: ${userId}`);
            } else {
                console.error('‚ùå No se pudo obtener el ID del usuario');
                alert('Error: No se pudo obtener tu informaci√≥n de usuario. Por favor, contacta al soporte.');
            }

            // Nombre completo
            if (user && user.nombre_completo) {
                document.getElementById('nombre').value = user.nombre_completo;
            } else if (user && user.nombre) {
                document.getElementById('nombre').value = user.nombre;
            } else if (user && user.nombres) {
                document.getElementById('nombre').value = user.nombres;
            } else if (user && user.empresa) {
                document.getElementById('nombre').value = user.empresa;
            }

            // Contacto (tel√©fono)
            if (user && user.telefono_contacto) {
                document.getElementById('contacto').value = user.telefono_contacto;
            } else if (user && user.telefono) {
                document.getElementById('contacto').value = user.telefono;
            } else if (user && user.celular) {
                document.getElementById('contacto').value = user.celular;
            } else if (user && user.phone) {
                document.getElementById('contacto').value = user.phone;
            }

            // Ubicaci√≥n (si est√° disponible en el perfil)
            if (user && user.ubicacion) {
                document.getElementById('ubicacion').value = user.ubicacion;
            } else if (user && user.ciudad) {
                document.getElementById('ubicacion').value = user.ciudad;
            } else if (user && user.direccion) {
                document.getElementById('ubicacion').value = user.direccion;
            } else if (user && user.location) {
                document.getElementById('ubicacion').value = user.location;
            }

            // Descripci√≥n del perfil
            if (user && user.descripcion_perfil) {
                document.getElementById('descripcion').value = user.descripcion_perfil;
            } else if (user && user.descripcion) {
                document.getElementById('descripcion').value = user.descripcion;
            } else if (user && user.bio) {
                document.getElementById('descripcion').value = user.bio;
            }

            // Experiencia (si est√° disponible en el perfil)
            if (user && user.experiencia) {
                document.getElementById('experiencia').value = user.experiencia;
            } else if (user && user.anios_experiencia) {
                document.getElementById('experiencia').value = user.anios_experiencia;
            } else if (user && user.experience) {
                document.getElementById('experiencia').value = user.experience;
            }
        }

        // Mostrar/ocultar loading
        function showLoading(show) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        // Redirigir al login
        function redirectToLogin() {
            alert('Debes iniciar sesi√≥n para publicar tu talento');
            window.location.href = "/login/";
        }

        // FUNCI√ìN MEJORADA - Enviar formulario con detecci√≥n de tipo de usuario
        async function submitTalentForm() {
            console.log('üéØ Iniciando publicaci√≥n...');
            
            // Obtener datos del usuario desde localStorage o variable global
            const storedUserData = localStorage.getItem('user_data');
            const userData = storedUserData ? JSON.parse(storedUserData) : window.userData;
            
            if (!userData) {
                console.error('‚ùå No hay datos de usuario disponibles');
                alert('Error: No se pudieron cargar tus datos. Por favor, recarga la p√°gina.');
                return;
            }
            
            // Obtener ID del usuario usando la funci√≥n mejorada
            const userId = getUserId(userData);
            
            if (!userId) {
                console.error('‚ùå No se pudo obtener el ID del usuario');
                alert('Error: No se pudo identificar tu usuario. Por favor, contacta al soporte.');
                return;
            }

            // Obtener tipo de usuario
            const userType = document.getElementById('userType').value;
            console.log(`üë§ Tipo de usuario para publicaci√≥n: ${userType}`);
            
            // Obtener valores del formulario
            const nombre = document.getElementById('nombre').value;
            const id_categoria = document.getElementById('categoria').value;
            const tipo_membresia = document.getElementById('membresia').value;
            const contacto = document.getElementById('contacto').value;
            const ubicacion = document.getElementById('ubicacion').value;
            const experiencia = document.getElementById('experiencia').value;
            const descripcion_detallada = document.getElementById('descripcion').value;
            
            console.log('üìã Datos del formulario:', {
                userId, userType, nombre, id_categoria, tipo_membresia, contacto, ubicacion, experiencia, descripcion_detallada
            });
            
            // Validaciones
            if (!nombre || !id_categoria || !contacto) {
                alert('‚ùå Por favor completa todos los campos obligatorios');
                return;
            }

            const token = localStorage.getItem('access_token');
            if (!token) {
                alert('üîê No est√°s autenticado. Por favor inicia sesi√≥n.');
                return;
            }

            showLoading(true);

            try {
                // Crear t√≠tulo seg√∫n el tipo de usuario
                let titulo = '';
                if (userType === 'empresa') {
                    titulo = `Oferta Empresa: ${nombre} - ${getCategoryName(id_categoria)}`;
                } else {
                    titulo = `Talento: ${nombre} - ${getCategoryName(id_categoria)}`;
                }

                // ESTRUCTURA EXACTA QUE ESPERA EL BACKEND
                const publicationData = {
                    id_usuario: parseInt(userId),
                    id_categoria: parseInt(id_categoria),
                    titulo_publicidad: titulo,
                    descripcion_detallada: descripcion_detallada || 'Sin descripci√≥n detallada',
                    tipo_membresia_vinculada: tipo_membresia,
                    estado_publicacion: 'activa',
                    // Campos adicionales
                    contacto: contacto,
                    ubicacion: ubicacion || 'No especificada',
                    experiencia: experiencia ? parseInt(experiencia) : 0,
                    // Agregar tipo de usuario al env√≠o
                    tipo_usuario: userType
                };

                console.log('üì§ Enviando datos exactos:', publicationData);

                const response = await fetch(`${BACKEND_URL}/api/publicidades/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(publicationData)
                });

                console.log('üì• Respuesta del servidor:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Publicaci√≥n exitosa:', result);
                    
                    let successMessage = '';
                    if (userType === 'empresa') {
                        successMessage = `üéâ ¬°Oferta de empresa publicada exitosamente!\n\nEmpresa: ${nombre}\nCategor√≠a: ${getCategoryName(id_categoria)}\nContacto: ${contacto}\nUbicaci√≥n: ${ubicacion}`;
                    } else {
                        successMessage = `üéâ ¬°Talento publicado exitosamente!\n\nNombre: ${nombre}\nCategor√≠a: ${getCategoryName(id_categoria)}\nContacto: ${contacto}\nUbicaci√≥n: ${ubicacion}`;
                    }
                    
                    alert(successMessage);
                    
                    // Limpiar solo algunos campos
                    document.getElementById('categoria').value = '';
                    document.getElementById('descripcion').value = '';
                    document.getElementById('experiencia').value = '';
                    
                } else {
                    const errorData = await response.json();
                    console.error('‚ùå Error del servidor:', errorData);
                    
                    // Si hay error con tipo_membresia, probar diferentes valores
                    if (errorData.tipo_membresia_vinculada) {
                        console.log('üîÑ Probando diferentes valores de membres√≠a...');
                        
                        // Lista de valores posibles para probar
                        const posiblesMembresias = ['1', '2', '3', 'basica', 'premium', 'empresa', 'gratuita', 'estandar', 'B√°sica', 'Premium', 'Empresa'];
                        
                        for (let membresia of posiblesMembresias) {
                            console.log(`üîÑ Probando membres√≠a: ${membresia}`);
                            
                            const testData = {
                                ...publicationData,
                                tipo_membresia_vinculada: membresia
                            };
                            
                            const testResponse = await fetch(`${BACKEND_URL}/api/publicidades/`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(testData)
                            });
                            
                            if (testResponse.ok) {
                                const result = await testResponse.json();
                                console.log(`‚úÖ Publicaci√≥n exitosa con membres√≠a: ${membresia}`, result);
                                
                                let successMessage = userType === 'empresa' 
                                    ? 'üéâ ¬°Oferta de empresa publicada exitosamente!' 
                                    : 'üéâ ¬°Talento publicado exitosamente!';
                                alert(successMessage);
                                
                                // Limpiar campos
                                document.getElementById('categoria').value = '';
                                document.getElementById('descripcion').value = '';
                                document.getElementById('experiencia').value = '';
                                return;
                            }
                        }
                        
                        throw new Error(`No se encontr√≥ un valor v√°lido para tipo_membresia_vinculada. Valores probados: ${posiblesMembresias.join(', ')}`);
                    } else {
                        throw new Error(`Error ${response.status}: ${JSON.stringify(errorData)}`);
                    }
                }
                
            } catch (error) {
                console.error('üí• Error completo:', error);
                alert('‚ùå Error al publicar: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Obtener nombre legible de la categor√≠a
        function getCategoryName(categoryValue) {
            const categoryMap = {
                '1': 'Electricidad',
                '2': 'Construcci√≥n',
                '3': 'Plomer√≠a',
                '4': 'Carpinter√≠a',
                '5': 'Refrigeraci√≥n / Aire Acondicionado',
                '6': 'Mec√°nica automotriz',
                '7': 'Turismo / Gu√≠as / Hoteler√≠a',
                '8': 'Limpieza',
                '9': 'Reposter√≠a',
                '10': 'Tutor√≠as / Educaci√≥n',
                '11': 'Cuidado infantil / Adultos mayores',
                '12': 'Belleza',
                '13': 'Otros'
            };
            
            return categoryMap[categoryValue] || 'Categor√≠a desconocida';
        }

        // Funci√≥n para volver atr√°s
        function goBack() {
            if (document.referrer) {
                window.history.back();
            } else {
                // Si no hay p√°gina anterior, redirigir a la p√°gina principal
                window.location.href = '/';
            }
        }
    </script>
</body>
</html>