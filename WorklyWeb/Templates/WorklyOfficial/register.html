<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WORKLY - Registrarse</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            padding: 2rem 0;
        }
        .register-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            max-width: 800px;
            margin: 0 auto;
        }
        .register-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        .workly-brand {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0;
        }
        .btn-workly {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px;
            font-weight: 600;
            width: 100%;
        }
        .btn-workly:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            color: white;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .login-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }
        .login-link:hover {
            color: #5a6fd8;
            text-decoration: underline;
        }
        .divider {
            border-top: 2px solid #e9ecef;
            margin: 1.5rem 0;
            position: relative;
        }
        .divider-text {
            background: white;
            padding: 0 1rem;
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            color: #6c757d;
            font-size: 0.9rem;
        }
        .form-section {
            margin-bottom: 2rem;
        }
        .section-title {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }
        .day-schedule {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f8f9fa;
        }
        .day-header {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        .time-input-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .time-input {
            flex: 1;
        }
        .not-available-btn {
            width: 100%;
            margin-top: 0.5rem;
        }
        .schedule-active {
            background: #e8f5e8;
            border-color: #28a745;
        }
        .alert {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12">
                <div class="register-card">
                    <!-- Header -->
                    <div class="register-header">
                        <h1 class="workly-brand">üöÄ WORKLY</h1>
                        <p class="mb-0 mt-2">Crear tu cuenta profesional</p>
                    </div>
                    
                    <!-- Register Form -->
                    <div class="p-4">
                        <!-- Alertas -->
                        <div id="successAlert" class="alert alert-success" role="alert">
                            ¬°Cuenta creada exitosamente! Redirigiendo...
                        </div>
                        <div id="errorAlert" class="alert alert-danger" role="alert">
                            Error al crear la cuenta. Por favor, intenta nuevamente.
                        </div>
                        <div id="validationAlert" class="alert alert-warning" role="alert">
                            Por favor, completa todos los campos requeridos correctamente.
                        </div>

                        <form id="registerForm">
                            {% csrf_token %}
                            
                            <!-- Informaci√≥n B√°sica -->
                            <div class="form-section">
                                <h4 class="section-title">Informaci√≥n B√°sica</h4>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="nombre_completo" class="form-label fw-semibold">Nombre completo *</label>
                                        <input type="text" class="form-control" id="nombre_completo" name="nombre_completo" placeholder="Juan P√©rez Garc√≠a" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="correo_electronico" class="form-label fw-semibold">Correo electr√≥nico *</label>
                                        <input type="email" class="form-control" id="correo_electronico" name="correo_electronico" placeholder="tu@correo.com" required>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="telefono_contacto" class="form-label fw-semibold">Tel√©fono de contacto</label>
                                        <input type="tel" class="form-control" id="telefono_contacto" name="telefono_contacto" placeholder="+52 55 1234 5678">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="tipo_usuario" class="form-label fw-semibold">Tipo de usuario *</label>
                                        <select class="form-select" id="tipo_usuario" name="tipo_usuario" required>
                                            <option value="">Selecciona tu tipo</option>
                                            <option value="talento_humano">Talento Humano</option>
                                            <option value="empresa">Empresa</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Descripci√≥n del Perfil -->
                            <div class="form-section">
                                <h4 class="section-title">Descripci√≥n del Perfil</h4>
                                <div class="mb-3">
                                    <label for="descripcion_perfil" class="form-label fw-semibold">Describe tu perfil profesional</label>
                                    <textarea class="form-control" id="descripcion_perfil" name="descripcion_perfil" rows="4" placeholder="Ej: Desarrollador full-stack con 5 a√±os de experiencia en JavaScript, Python y React. Especializado en aplicaciones web escalables..."></textarea>
                                    <div class="form-text">Esta descripci√≥n aparecer√° en tu perfil p√∫blico.</div>
                                </div>
                            </div>

                            <!-- Horarios de Atenci√≥n -->
                            <div class="form-section">
                                <h4 class="section-title">Horarios de Atenci√≥n</h4>
                                <p class="text-muted mb-3">Selecciona tus horarios disponibles para contactos profesionales</p>
                                
                                <div id="horariosContainer">
                                    <!-- Los horarios se generar√°n din√°micamente -->
                                </div>
                            </div>

                            <!-- Contrase√±as -->
                            <div class="form-section">
                                <h4 class="section-title">Seguridad</h4>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="password" class="form-label fw-semibold">Contrase√±a *</label>
                                        <input type="password" class="form-control" id="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                                        <div class="form-text">M√≠nimo 8 caracteres</div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="confirm_password" class="form-label fw-semibold">Confirmar contrase√±a *</label>
                                        <input type="password" class="form-control" id="confirm_password" name="confirm_password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                                    </div>
                                </div>
                            </div>

                            <!-- Divider -->
                            <div class="divider">
                                <span class="divider-text">Listo para comenzar</span>
                            </div>
                            
                            <!-- Register Button -->
                            <div class="d-grid mb-3">
                                <button type="submit" class="btn btn-workly btn-lg" id="submitBtn">
                                    <span id="submitText">Crear Cuenta</span>
                                    <div id="submitSpinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </button>
                            </div>
                            
                            <!-- Login Link -->
                            <div class="text-center">
                                <p class="mb-0">
                                    ¬øYa tienes una cuenta? 
                                    <a href="/login/" class="login-link">Iniciar sesi√≥n</a>
                                </p>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript para horarios y conexi√≥n con backend -->
    <script>
        const BACKEND_URL = 'http://127.0.0.1:8001';  // Tu backend
        const REGISTER_ENDPOINT = `${BACKEND_URL}/auth/register/`;
        const LOGIN_FRONTEND_URL = '/login/';  // URL del frontend para login

        // D√≠as de la semana
        const daysOfWeek = [
            { id: 'lunes', name: 'Lunes' },
            { id: 'martes', name: 'Martes' },
            { id: 'miercoles', name: 'Mi√©rcoles' },
            { id: 'jueves', name: 'Jueves' },
            { id: 'viernes', name: 'Viernes' },
            { id: 'sabado', name: 'S√°bado' },
            { id: 'domingo', name: 'Domingo' }
        ];

        // Generar horarios din√°micamente
        function generateScheduleFields() {
            const container = document.getElementById('horariosContainer');
            container.innerHTML = '';

            daysOfWeek.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'day-schedule schedule-active';
                dayElement.innerHTML = `
                    <div class="day-header">${day.name}</div>
                    <div class="time-input-group">
                        <div class="time-input">
                            <label class="form-label small">Hora de inicio</label>
                            <input type="time" class="form-control" id="${day.id}_start" name="${day.id}_start" value="09:00">
                        </div>
                        <div class="time-input">
                            <label class="form-label small">Hora de fin</label>
                            <input type="time" class="form-control" id="${day.id}_end" name="${day.id}_end" value="18:00">
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-secondary not-available-btn" onclick="toggleNotAvailable('${day.id}')">
                        No disponible
                    </button>
                    <input type="hidden" id="${day.id}_available" name="${day.id}_available" value="true">
                `;
                container.appendChild(dayElement);
            });
        }

        // Alternar disponibilidad
        function toggleNotAvailable(dayId) {
            const dayElement = document.querySelector(`#${dayId}_start`).closest('.day-schedule');
            const startInput = document.getElementById(`${dayId}_start`);
            const endInput = document.getElementById(`${dayId}_end`);
            const availableInput = document.getElementById(`${dayId}_available`);
            const button = dayElement.querySelector('.not-available-btn');

            if (availableInput.value === 'true') {
                // Marcar como no disponible
                startInput.disabled = true;
                endInput.disabled = true;
                availableInput.value = 'false';
                button.textContent = 'Marcar como disponible';
                button.classList.remove('btn-outline-secondary');
                button.classList.add('btn-outline-success');
                dayElement.classList.remove('schedule-active');
            } else {
                // Marcar como disponible
                startInput.disabled = false;
                endInput.disabled = false;
                availableInput.value = 'true';
                button.textContent = 'No disponible';
                button.classList.remove('btn-outline-success');
                button.classList.add('btn-outline-secondary');
                dayElement.classList.add('schedule-active');
            }
        }

        // Preparar datos de horarios para enviar
        function prepareScheduleData() {
            const horarios = {};
            
            daysOfWeek.forEach(day => {
                const available = document.getElementById(`${day.id}_available`).value === 'true';
                
                if (available) {
                    const start = document.getElementById(`${day.id}_start`).value;
                    const end = document.getElementById(`${day.id}_end`).value;
                    horarios[day.id] = `${start}-${end}`;
                } else {
                    horarios[day.id] = 'No disponible';
                }
            });
            
            return horarios;
        }

        // Mostrar alerta
        function showAlert(alertId, message = '') {
            // Ocultar todas las alertas primero
            document.querySelectorAll('.alert').forEach(alert => {
                alert.style.display = 'none';
            });
            
            const alert = document.getElementById(alertId);
            if (message) {
                alert.innerHTML = message;
            }
            alert.style.display = 'block';
            
            // Auto-ocultar alertas de error despu√©s de 5 segundos
            if (alertId === 'errorAlert' || alertId === 'validationAlert') {
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 5000);
            }
        }

        // Validaci√≥n del formulario
        async function handleRegister(event) {
            event.preventDefault();
            
            console.log('üéØ Iniciando registro...');
            
            // Ocultar alertas previas
            showAlert('successAlert');
            showAlert('errorAlert');
            showAlert('validationAlert');

            const password = document.getElementById('password').value;
            const confirm_password = document.getElementById('confirm_password').value;
            const nombreCompleto = document.getElementById('nombre_completo').value;
            const correoElectronico = document.getElementById('correo_electronico').value;
            const tipoUsuario = document.getElementById('tipo_usuario').value;
            
            console.log('üìã Datos del formulario:', {
                nombreCompleto,
                correoElectronico,
                tipoUsuario,
                passwordLength: password.length,
                confirmPasswordLength: confirm_password.length
            });
            
            // Validaciones b√°sicas
            if (!nombreCompleto || !correoElectronico || !tipoUsuario || !password || !confirm_password) {
                showAlert('validationAlert', 'Por favor, completa todos los campos requeridos.');
                return false;
            }
            
            if (password !== confirm_password) {
                showAlert('validationAlert', 'Las contrase√±as no coinciden. Por favor, verifica.');
                return false;
            }
            
            if (password.length < 8) {
                showAlert('validationAlert', 'La contrase√±a debe tener al menos 8 caracteres.');
                return false;
            }

            // Mostrar loading
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const submitSpinner = document.getElementById('submitSpinner');
            
            submitBtn.disabled = true;
            submitText.textContent = 'Creando cuenta...';
            submitSpinner.style.display = 'inline-block';

            try {
                // Preparar datos EXACTAMENTE como los espera tu backend
                const formData = {
                    nombre_completo: nombreCompleto,
                    correo_electronico: correoElectronico,
                    tipo_usuario: tipoUsuario,
                    descripcion_perfil: document.getElementById('descripcion_perfil').value || '',
                    telefono_contacto: document.getElementById('telefono_contacto').value || '',
                    password: password,
                    password_confirm: confirm_password,
                    horarios_atencion: prepareScheduleData()
                };

                console.log('üì§ Enviando datos al backend:', formData);
                console.log('üîó Endpoint:', REGISTER_ENDPOINT);

                // Enviar datos al backend usando el endpoint correcto
                const response = await fetch(REGISTER_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                console.log('üì• Respuesta del servidor - Status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Registro exitoso:', data);
                    
                    // Mostrar mensaje de √©xito
                    showAlert('successAlert', '¬°Cuenta creada exitosamente! Redirigiendo al login...');
                    
                    // Limpiar formulario
                    document.getElementById('registerForm').reset();
                    
                    // Redirigir al LOGIN DEL FRONTEND despu√©s de 2 segundos
                    setTimeout(() => {
                        console.log('üîÑ Redirigiendo a:', LOGIN_FRONTEND_URL);
                        window.location.href = LOGIN_FRONTEND_URL;
                    }, 2000);
                    
                } else {
                    const errorData = await response.json();
                    console.error('‚ùå Error del servidor:', errorData);
                    
                    // Manejar errores espec√≠ficos
                    let errorMessage = 'Error al crear la cuenta.';
                    
                    if (errorData.detail) {
                        errorMessage = errorData.detail;
                    } else if (errorData.error) {
                        errorMessage = errorData.error;
                    } else if (errorData.message) {
                        errorMessage = errorData.message;
                    } else if (errorData.non_field_errors) {
                        errorMessage = errorData.non_field_errors.join(', ');
                    } else if (typeof errorData === 'object') {
                        // Mostrar errores de campo espec√≠ficos
                        const fieldErrors = [];
                        for (const [field, errors] of Object.entries(errorData)) {
                            if (Array.isArray(errors)) {
                                fieldErrors.push(`${field}: ${errors.join(', ')}`);
                            }
                        }
                        if (fieldErrors.length > 0) {
                            errorMessage = fieldErrors.join(' | ');
                        }
                    }
                    
                    showAlert('errorAlert', `Error: ${errorMessage}`);
                }

            } catch (error) {
                console.error('üí• Error de conexi√≥n:', error);
                showAlert('errorAlert', 'Error de conexi√≥n con el servidor. Verifica que el backend est√© ejecut√°ndose.');
            } finally {
                // Restaurar bot√≥n
                submitBtn.disabled = false;
                submitText.textContent = 'Crear Cuenta';
                submitSpinner.style.display = 'none';
            }
        }
    
        // Inicializar horarios al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            generateScheduleFields();
            
            // Asignar el event listener al formulario
            const registerForm = document.getElementById('registerForm');
            if (registerForm) {
                registerForm.addEventListener('submit', handleRegister);
                console.log('‚úÖ Formulario de registro listo');
            } else {
                console.error('‚ùå No se encontr√≥ el formulario de registro');
            }
            
            // Agregar validaci√≥n en tiempo real para contrase√±as
            const passwordInput = document.getElementById('password');
            const confirmPasswordInput = document.getElementById('confirm_password');
            
            if (passwordInput && confirmPasswordInput) {
                function validatePasswords() {
                    const password = passwordInput.value;
                    const confirmPassword = confirmPasswordInput.value;
                    
                    if (password && confirmPassword && password !== confirmPassword) {
                        confirmPasswordInput.classList.add('is-invalid');
                        confirmPasswordInput.classList.remove('is-valid');
                    } else if (password && confirmPassword && password === confirmPassword) {
                        confirmPasswordInput.classList.remove('is-invalid');
                        confirmPasswordInput.classList.add('is-valid');
                    } else {
                        confirmPasswordInput.classList.remove('is-invalid', 'is-valid');
                    }
                }
                
                passwordInput.addEventListener('input', validatePasswords);
                confirmPasswordInput.addEventListener('input', validatePasswords);
            }
            
            // Test de conexi√≥n al backend
            console.log('üîç Probando conexi√≥n con el backend...');
            fetch(`${BACKEND_URL}/`)
                .then(response => {
                    if (response.ok) {
                        console.log('‚úÖ Backend disponible');
                    } else {
                        console.warn('‚ö†Ô∏è Backend respondi√≥ con error');
                    }
                })
                .catch(error => {
                    console.error('‚ùå No se puede conectar al backend:', error);
                });
        });
    </script>
</body>
</html>